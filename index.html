<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart NoteDB</title>
    <style>
        :root {
            --primary: #007bff;
            --primary-hover: #0069d9;
            --danger: #dc3545;
            --bg: #f8f9fa;
            --card-bg: #ffffff;
            --border: #dee2e6;
        }

        body {
            font-family: -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 0; padding: 30px 20px;
            background-color: var(--bg); color: #333;
        }

        .container {
            max-width: 800px; margin: 0 auto;
            background: var(--card-bg); padding: 30px;
            border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        }

        h1 { margin-top: 0; color: #2c3e50; text-align: center; font-size: 26px; }

        .input-group { margin-bottom: 15px; position: relative; }
        label { display: block; margin-bottom: 5px; font-weight: 600; color: #555; font-size: 13px;}
        input[type="text"] {
            width: 100%; padding: 10px; border: 1px solid var(--border);
            border-radius: 5px; font-size: 15px; font-family: monospace;
            box-sizing: border-box;
        }
        input[type="text"]:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(0,123,255,0.1); }

        .btn-row { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 20px; }
        button {
            flex: 1; min-width: 80px; padding: 10px; border: none; border-radius: 5px;
            background: var(--primary); color: white; cursor: pointer; font-weight: 500;
            transition: 0.2s;
        }
        button:hover { background: var(--primary-hover); transform: translateY(-1px); }
        .btn-danger { background: var(--danger); }
        .btn-danger:hover { background: #c82333; }
        .btn-ghost { background: transparent; color: #666; border: 1px solid #ddd; }
        .btn-ghost:hover { background: #eee; color: #333; }
        
        /* æœç´¢æŒ‰é’® */
        .btn-search-online {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white; font-weight: bold;
        }

        /* ç»“æœåŒºåŸŸ */
        .output { margin-top: 25px; border-top: 1px solid #eee; padding-top: 20px; }
        .msg { padding: 10px; border-radius: 5px; margin-bottom: 15px; font-size: 14px; display: none;}
        .msg.success { background: #d4edda; color: #155724; display: block; }
        .msg.error { background: #f8d7da; color: #721c24; display: block; }

        /* è¡¨æ ¼æ ·å¼ */
        table { width: 100%; border-collapse: collapse; font-size: 14px; }
        th { text-align: left; padding: 10px; background: #f1f3f5; color: #495057; }
        td { padding: 10px; border-bottom: 1px solid #eee; vertical-align: middle; }
        .tag-part { display: inline-block; background: #e9ecef; color: #495057; padding: 2px 6px; border-radius: 4px; font-size: 12px; margin-right: 4px; }
        .key-final { font-weight: bold; color: #2c3e50; }
        .btn-read { background-color: #6f42c1; color: white; padding: 4px 10px; text-decoration: none; border-radius: 4px; font-size: 12px; margin-right: 5px; display: inline-block; }
        .copy-btn { background: none; border: 1px solid #ddd; color: #666; padding: 2px 8px; font-size: 11px; border-radius: 3px; cursor: pointer; margin-left: 8px; }

        /* === æœç´¢æ¨¡æ€æ¡† === */
        #searchModal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;
        }
        .search-box {
            background: white; width: 90%; max-width: 600px; padding: 20px; border-radius: 10px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2); max-height: 80vh; display: flex; flex-direction: column;
        }
        .search-results { overflow-y: auto; margin-top: 15px; flex: 1; border-top: 1px solid #eee; }
        .result-item {
            padding: 12px; border-bottom: 1px solid #f0f0f0; cursor: pointer; transition: background 0.2s;
        }
        .result-item:hover { background: #f8f9fa; }
        .r-title { font-weight: bold; color: #007bff; font-size: 15px; }
        .r-url { font-size: 12px; color: #999; margin-top: 4px; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; }
        .r-key { font-size: 12px; color: #28a745; margin-top: 2px; }

        /* === æ·±åº¦åˆ†ææ¨¡æ€æ¡† (Insight) === */
        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.4); backdrop-filter: blur(5px); z-index: 2000;
            justify-content: center; align-items: center;
        }
        .insight-card {
            background: white; width: 90%; max-width: 700px; 
            border-radius: 20px; box-shadow: 0 20px 50px rgba(0,0,0,0.15);
            overflow: hidden; animation: popIn 0.3s ease-out;
            display: flex; flex-direction: column;
        }
        @keyframes popIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        
        .insight-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px 25px; color: white; display: flex; justify-content: space-between; align-items: center;
        }
        
        .insight-header h2 { 
            margin: 0; font-size: 22px; font-weight: 600; letter-spacing: 0.5px;
        }
        
        /* ä¿®å¤åçš„å…³é—­æŒ‰é’®æ ·å¼ */
        /* ä¿®å¤åçš„å…³é—­æŒ‰é’®æ ·å¼ */
        .close-btn { 
            /* === å…³é”®ä¿®å¤ï¼šé‡ç½®å…¨å±€ button æ ·å¼ === */
            flex: none;        /* ç¦æ­¢è‡ªåŠ¨ä¼¸ç¼© */
            min-width: auto;   /* å–æ¶ˆ 80px çš„æœ€å°å®½åº¦é™åˆ¶ */
            background: rgba(255,255,255,0.2); 
            border: none; 
            color: white; 
            
            /* å¼ºåˆ¶å›ºå®šå®½é«˜ï¼Œç°åœ¨ min-width è¢«å–æ¶ˆäº†ï¼Œè¿™é‡Œæ‰ä¼šç”Ÿæ•ˆ */
            width: 32px; 
            height: 32px; 
            
            border-radius: 50%; 
            cursor: pointer; 
            padding: 0; 
            margin-left: 15px;
            
            /* ä½¿ç”¨ Flex å®Œç¾å±…ä¸­ç¬¦å· */
            display: flex; 
            align-items: center; 
            justify-content: center;
            
            /* å­—ä½“è®¾ç½® */
            font-family: Arial, sans-serif; 
            font-size: 20px; 
            line-height: 1;
            
            transition: all 0.2s ease;
        }
        
        .close-btn:hover { 
            background: rgba(255,255,255,0.4); 
            transform: rotate(90deg); 
        }
        
        .close-btn:active { transform: scale(0.9); }
        
        .insight-body { padding: 30px; display: grid; gap: 25px; }
        
        /* æ•°æ®æ¦‚è§ˆå¡ç‰‡ */
        .stats-row { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; }
        .stat-box {
            background: #f8f9fa; border-radius: 12px; padding: 15px; text-align: center;
            border: 1px solid #eee; transition: transform 0.2s;
        }
        .stat-box:hover { transform: translateY(-3px); border-color: #dbe4ff; background: #f0f7ff; }
        .stat-num { font-size: 24px; font-weight: 700; color: #2c3e50; margin-bottom: 5px; }
        .stat-label { font-size: 12px; color: #888; text-transform: uppercase; letter-spacing: 1px; }

        /* çƒ­åŠ›å›¾ */
        .heatmap-container { margin-top: 10px; }
        .heatmap-title { font-size: 14px; font-weight: 600; color: #555; margin-bottom: 10px; display: flex; justify-content: space-between;}
        .heatmap-grid {
            display: flex; gap: 4px; height: 60px; align-items: flex-end; justify-content: space-between;
        }
        .heat-bar {
            flex: 1; background: #e9ecef; border-radius: 3px; position: relative;
            transition: height 0.5s ease; min-height: 4px;
        }
        .heat-bar:hover::after {
            content: attr(data-date) " : " attr(data-count) "ç« ";
            position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%);
            background: #333; color: white; padding: 4px 8px; border-radius: 4px;
            font-size: 10px; white-space: nowrap; pointer-events: none; margin-bottom: 5px; z-index: 10;
        }

        /* å…³é”®è¯ */
        .tags-cloud { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; margin-top: 10px; }
        .tag-pill {
            background: white; border: 1px solid #e0e0e0; color: #555;
            padding: 5px 12px; border-radius: 20px; font-size: 12px; font-weight: 500;
        }
        .tag-pill.top-1 { background: #fff0f6; border-color: #ffadd2; color: #c41d7f; }
        .tag-pill.top-2 { background: #e6f7ff; border-color: #91d5ff; color: #096dd9; }
        .tag-pill.top-3 { background: #f6ffed; border-color: #b7eb8f; color: #389e0d; }
        /* === è§†å›¾åˆ‡æ¢æŒ‰é’® === */
        .view-toggle {
            display: flex; justify-content: flex-end; margin-bottom: 15px;
        }
        .toggle-btn {
            background: transparent; border: 1px solid #ddd; color: #666;
            padding: 5px 10px; cursor: pointer; margin-left: -1px;
            font-size: 14px; min-width: auto;
        }
        .toggle-btn.active {
            background: #e9ecef; color: #333; font-weight: bold; border-color: #ccc;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.05);
        }
        .toggle-btn:first-child { border-radius: 4px 0 0 4px; }
        .toggle-btn:last-child { border-radius: 0 4px 4px 0; }

        /* === ç½‘æ ¼ä¹¦æ¶æ¨¡å¼ === */
        .bookshelf-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 20px; padding: 10px 0;
        }
        
        .book-card {
            background: white; border-radius: 8px; overflow: hidden;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: pointer; position: relative;
            display: flex; flex-direction: column;
            aspect-ratio: 2 / 3; /* é»„é‡‘æ¯”ä¾‹ä¹¦ç±å°ºå¯¸ */
        }
        .book-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.12);
        }
        
        .book-cover {
            flex: 1; padding: 15px;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            text-align: center; color: white;
            background: linear-gradient(135deg, #667eea, #764ba2); /* é»˜è®¤èƒŒæ™¯ï¼Œä¼šè¢«JSè¦†ç›– */
            position: relative;
        }
        
        /* ä¹¦è„Šæ•ˆæœ */
        .book-cover::before {
            content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 4px;
            background: rgba(255,255,255,0.2);
            box-shadow: 1px 0 2px rgba(0,0,0,0.1);
        }
        
        .book-title-card {
            font-size: 16px; font-weight: bold; line-height: 1.4;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
            word-break: break-all;
            display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden;
        }
        
        .book-author-card {
            font-size: 10px; margin-top: 8px; opacity: 0.8;
            font-family: monospace;
        }

        .book-info-row {
            padding: 10px; background: white; border-top: 1px solid #f0f0f0;
            display: flex; justify-content: space-between; align-items: center;
        }
        .book-key-tag {
            font-size: 10px; background: #f0f0f0; color: #666; padding: 2px 6px; border-radius: 4px;
        }
        .book-action-icon {
            font-size: 14px; color: #999; text-decoration: none;
        }
        .book-action-icon:hover { color: var(--primary); }
    </style>
</head>
<body>
    <div class="container">
        <h1>âš¡ Smart NoteDB</h1>
        
        <div class="input-group">
            <label>Key (æ‹¼éŸ³ç¼©å†™ï¼Œæ”¯æŒ "/" åˆ†ç±»)</label>
            <input type="text" id="key" placeholder="ä¾‹å¦‚: frxxz (å‡¡äººä¿®ä»™ä¼ )" onkeydown="handleEnter(event)">
        </div>
        
        <div class="input-group">
            <label>Value (é“¾æ¥)</label>
            <input type="text" id="value" placeholder="https://..." onkeydown="handleEnter(event)">
        </div>

        <div class="btn-row">
            <button onclick="doAction('insert')">Save / Insert</button>
            <button onclick="doAction('find')" style="background-color: #17a2b8;">Search DB</button>
            
            <!-- æ–°å¢æœç´¢æŒ‰é’® -->
            <button onclick="openSearchModal()" class="btn-search-online">ğŸ” æœå°è¯´</button>
            
            <button class="btn-ghost" onclick="doAction('list')">List All</button>
            <button class="btn-ghost" onclick="doRollback()" style="color: #e67e22; border-color: #e67e22;">âª Undo</button>
            <!-- <button class="btn-ghost" onclick="clearInputs()">Clear</button> -->
            <!-- åŸæœ‰çš„æŒ‰é’®... -->
            <button onclick="openInsight()" style="background: linear-gradient(45deg, #11998e, #38ef7d);">ğŸ“Š é˜…è¯»æ´å¯Ÿ</button>
            <button class="btn-danger" onclick="doAction('remove')">Remove</button>
        </div>

        <div class="output">
            <!-- è§†å›¾åˆ‡æ¢å™¨ -->
            <div class="view-toggle">
                <button class="toggle-btn active" onclick="switchView('list')" title="åˆ—è¡¨è§†å›¾">â˜° List</button>
                <button class="toggle-btn" onclick="switchView('grid')" title="ç½‘æ ¼ä¹¦æ¶">â˜· Grid</button>
            </div>

            <div id="msgBox" class="msg"></div>
            <!-- è¿™é‡Œå®¹å™¨ä¸å˜ï¼Œå†…å®¹ç”±JSå†³å®šæ¸²æŸ“ä»€ä¹ˆ -->
            <div id="tableContainer"></div>
        </div>
    </div>

    <!-- æœç´¢æ¨¡æ€æ¡† -->
    <div id="searchModal">
        <div class="search-box">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <h3 style="margin:0;">å…¨ç½‘æœä¹¦</h3>
                <button onclick="closeSearchModal()" style="background:none; color:#999; width:auto; padding:0; font-size:20px;">Ã—</button>
            </div>
            <div style="display:flex; gap:10px;">
                <input type="text" id="onlineSearchInput" placeholder="è¾“å…¥å°è¯´åï¼Œå¦‚ï¼šå‡¡äººä¿®ä»™ä¼ " onkeydown="if(event.key==='Enter') doOnlineSearch()">
                <button onclick="doOnlineSearch()" style="flex:0 0 80px;">æœç´¢</button>
            </div>
            <div class="search-results" id="searchResults">
                <div style="text-align:center; padding:20px; color:#999;">è¯·è¾“å…¥ä¹¦åæœç´¢...</div>
            </div>
        </div>
    </div>
    <!-- æ·±åº¦åˆ†ææ¨¡æ€æ¡† -->
    <div id="insightModal" class="modal-overlay">
        <div class="insight-card">
            <div class="insight-header">
                <h2>Reading Insights</h2>
                <button class="close-btn" onclick="closeInsight()">Ã—</button>
            </div>
            <div class="insight-body">
                <!-- 1. æ ¸å¿ƒæŒ‡æ ‡ -->
                <div class="stats-row">
                    <div class="stat-box">
                        <div class="stat-num" id="st-books">-</div>
                        <div class="stat-label">åœ¨è¯»ä¹¦ç±</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-num" id="st-words">-</div>
                        <div class="stat-label">ç´¯è®¡å­—æ•°(ä¸‡)</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-num" id="st-days">-</div>
                        <div class="stat-label">ç¼“å­˜ç« èŠ‚</div>
                    </div>
                </div>
    
                <!-- 2. æ´»è·ƒåº¦çƒ­åŠ›å›¾ -->
                <div class="heatmap-container">
                    <div class="heatmap-title">
                        <span>è¿‘30å¤©é˜…è¯»æ´»è·ƒåº¦</span>
                        <span style="font-size:12px; color:#999; font-weight:400">åŸºäºæœ¬åœ°ç¼“å­˜æ•°æ®</span>
                    </div>
                    <div class="heatmap-grid" id="heatmapGrid">
                        <!-- JS ç”ŸæˆæŸ±çŠ¶å›¾ -->
                    </div>
                </div>
    
                <!-- 3. é˜…è¯»åå¥½ -->
                <div style="text-align: center; margin-top: 10px;">
                    <div class="heatmap-title" style="justify-content: center;">é˜…è¯»å£å‘³å…³é”®è¯</div>
                    <div class="tags-cloud" id="tagsCloud">
                        <!-- JS ç”Ÿæˆ -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>
        const API_URL = 'http://127.0.0.1:5000';
        let currentView = 'list'; // é»˜è®¤è§†å›¾
        let currentData = {};     // ä¿å­˜å½“å‰æ•°æ®ï¼Œæ–¹ä¾¿åˆ‡æ¢è§†å›¾æ—¶ä¸ç”¨é‡æ–°è¯·æ±‚

        // æ ¹æ®å­—ç¬¦ä¸²ç”Ÿæˆå›ºå®šçš„æŸ”å’Œé¢œè‰²
        function stringToColor(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                hash = str.charCodeAt(i) + ((hash << 5) - hash);
            }
            // ä½¿ç”¨ HSL é¢œè‰²ç©ºé—´ï¼Œç¡®ä¿é¢œè‰²å¥½çœ‹ (é¥±å’Œåº¦ 60-80%, äº®åº¦ 40-60%)
            const h = Math.abs(hash) % 360;
            const s = 60 + (Math.abs(hash) % 20); 
            const l = 40 + (Math.abs(hash) % 20);
            return `hsl(${h}, ${s}%, ${l}%)`;
        }

        function switchView(view) {
            currentView = view;
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.toggle-btn').forEach(btn => {
                btn.classList.toggle('active', btn.innerText.toLowerCase().includes(view));
            });
            // é‡æ–°æ¸²æŸ“
            if (currentData) renderTable(currentData);
        }
        function handleEnter(e) {
            if (e.key !== 'Enter') return;
            if (e.target.id === 'value') doAction('insert');
            else if (e.target.id === 'key') doAction('find');
        }

async function doAction(action) {
    const key = document.getElementById('key').value.trim();
    const value = document.getElementById('value').value.trim();
    
    if (action !== 'list' && action !== 'find' && !key) return showMsg('Please enter a Key', 'error');

    try {
        const res = await fetch(`${API_URL}/${action}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ key, value })
        });
        const result = await res.json();
        
        showMsg(result.message || action + ' done', result.status);

        // === é€»è¾‘ä¿®æ”¹ç‚¹ ===
        
        if (['insert', 'update', 'remove', 'rollback'].includes(action)) {
            if(result.status === 'success') {
                // 1. å¦‚æœæ˜¯ ä¿å­˜(Insert) æˆ– æ›´æ–°(Update)
                //    ç›´æ¥è°ƒç”¨ findï¼Œå±•ç¤ºåˆšæ‰æ“ä½œçš„é‚£æ¡è®°å½•
                if (action === 'insert' || action === 'update') {
                    doAction('find'); 
                } 
                // 2. å¦‚æœæ˜¯ åˆ é™¤(Remove) æˆ– å›æ»š(Rollback)
                //    è¿˜æ˜¯åˆ·æ–°å…¨åˆ—è¡¨æ¯”è¾ƒç›´è§‚
                else {
                    doAction('list');
                }
            }
        }
        
        else if ((action === 'list' || action === 'find') && result.data) {
            renderTable(result.data);
        }

    } catch (err) {
        console.error(err);
        showMsg('Connection Error', 'error');
    }
}

        async function doRollback() {
            if(!confirm("ç¡®å®šå›é€€åˆ°ä¸Šä¸€æ­¥å—ï¼Ÿ")) return;
            const res = await fetch(`${API_URL}/rollback`, { method: 'POST' });
            const result = await res.json();
            showMsg(result.message, result.status);
            if(result.status === 'success') doAction('list');
        }

        // === æœç´¢åŠŸèƒ½ç›¸å…³ ===
        function openSearchModal() {
            document.getElementById('searchModal').style.display = 'flex';
            document.getElementById('onlineSearchInput').focus();
        }
        function closeSearchModal() {
            document.getElementById('searchModal').style.display = 'none';
        }

        async function doOnlineSearch() {
            const keyword = document.getElementById('onlineSearchInput').value.trim();
            if (!keyword) return;
            
            const resultsDiv = document.getElementById('searchResults');
            resultsDiv.innerHTML = '<div style="text-align:center; padding:20px; color:#666;">ğŸ” æ­£åœ¨æœç´¢ Bing...</div>';

            try {
                const res = await fetch(`${API_URL}/api/search_novel`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ keyword })
                });
                const result = await res.json();
                
                if (result.data && result.data.length > 0) {
                    let html = '';
                    result.data.forEach(item => {
                        html += `
                            <div class="result-item" onclick="selectResult('${item.suggested_key}', '${item.url}')">
                                <div class="r-title">${item.title}</div>
                                <div class="r-url">${item.url}</div>
                                <div class="r-key">å»ºè®® Key: <b>${item.suggested_key}</b></div>
                            </div>
                        `;
                    });
                    resultsDiv.innerHTML = html;
                } else {
                    resultsDiv.innerHTML = '<div style="text-align:center; padding:20px; color:#999;">æœªæ‰¾åˆ°ç›¸å…³ç»“æœï¼Œè¯·æ¢ä¸ªè¯è¯•è¯•ã€‚</div>';
                }
            } catch (e) {
                resultsDiv.innerHTML = '<div style="text-align:center; padding:20px; color:red;">æœç´¢å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œã€‚</div>';
            }
        }

        function selectResult(key, url) {
            // è‡ªåŠ¨å¡«å…¥ä¸»ç•Œé¢
            document.getElementById('key').value = key;
            document.getElementById('value').value = url;
            closeSearchModal();
            showMsg(`âœ¨ å·²è‡ªåŠ¨å¡«å…¥: ${key}`, 'success');
        }

        // === é€šç”¨å‡½æ•° ===
        function showMsg(text, type) {
            const box = document.getElementById('msgBox');
            box.innerText = text;
            box.className = `msg ${type}`;
        }

        function clearInputs() {
            document.getElementById('key').value = '';
            document.getElementById('value').value = '';
            document.getElementById('tableContainer').innerHTML = '';
            document.getElementById('msgBox').className = 'msg';
        }

        function copyText(text) {
            navigator.clipboard.writeText(text).then(() => showMsg('Copied!', 'success'));
        }

        function renderTable(data) {
            currentData = data; // ä¿å­˜æ•°æ®
            const container = document.getElementById('tableContainer');
            
            if (Object.keys(data).length === 0) {
                container.innerHTML = '<div style="text-align:center;color:#999;padding:40px;">ä¹¦æ¶ç©ºç©ºå¦‚ä¹Ÿ</div>';
                return;
            }

            // === åˆ†æµé€»è¾‘ ===
            if (currentView === 'grid') {
                renderGrid(data, container);
                return;
            }

            // === åŸæœ‰çš„åˆ—è¡¨æ¸²æŸ“é€»è¾‘ (ä¿æŒä¸å˜) ===
            let html = '<table><thead><tr><th width="30%">Key / Tags</th><th>Value & Actions</th></tr></thead><tbody>';
            Object.keys(data).sort().forEach(k => {
                const v = data[k];
                const parts = k.split('/');
                let keyHtml = '';
                parts.forEach((part, index) => {
                    if (index === parts.length - 1) keyHtml += `<span class="key-final">${part}</span>`;
                    else keyHtml += `<span class="tag-part">${part}</span>`;
                });
                const isLink = v.startsWith('http');
                let valHtml = isLink ? `<a href="${v}" target="_blank" style="color:#999;font-size:12px;margin-right:10px;">[æº] ${v.substring(0, 30)}...</a>` : `<span style="color:#333">${v}</span>`;
                let actionHtml = isLink ? `<a href="/read?url=${encodeURIComponent(v)}&key=${encodeURIComponent(k)}" class="btn-read" target="_blank">ğŸ“– çº¯å‡€é˜…è¯»</a>` : '';
                
                html += `<tr><td>${keyHtml}</td><td style="display:flex; justify-content:space-between;"><div>${valHtml}</div><div>${actionHtml}<button class="copy-btn" onclick="copyText('${v}')">Copy</button></div></td></tr>`;
            });
            html += '</tbody></table>';
            container.innerHTML = html;
        }

        // === æ–°å¢ï¼šç½‘æ ¼æ¸²æŸ“å‡½æ•° ===
        function renderGrid(data, container) {
            let html = '<div class="bookshelf-grid">';
            
            Object.keys(data).sort().forEach(k => {
                const v = data[k];
                // ä» Key ä¸­æå–ä¹¦å (å–æœ€åä¸€ä¸ªæ–œæ åçš„éƒ¨åˆ†)
                const parts = k.split('/');
                const titleKey = parts[parts.length - 1]; 
                
                // è‡ªåŠ¨ç”ŸæˆèƒŒæ™¯è‰²
                const bgStyle = `background: linear-gradient(135deg, ${stringToColor(titleKey)}, ${stringToColor(titleKey + 'dark')});`;
                
                // å°è¯•è§£æä¸­æ–‡å (å¦‚æœæ˜¯æ‹¼éŸ³, æš‚æ—¶æ˜¾ç¤ºæ‹¼éŸ³, ä»¥åå¯ä»¥ç»“åˆ AI ç¿»è¯‘)
                const displayName = titleKey.toUpperCase(); 

                const isLink = v.startsWith('http');
                const clickAction = isLink ? `window.open('/read?url=${encodeURIComponent(v)}&key=${encodeURIComponent(k)}', '_blank')` : `copyText('${v}')`;

                html += `
                    <div class="book-card" onclick="${clickAction}">
                        <div class="book-cover" style="${bgStyle}">
                            <div class="book-title-card">${displayName}</div>
                            <div class="book-author-card">TXT</div>
                        </div>
                        <div class="book-info-row">
                            <span class="book-key-tag">${titleKey}</span>
                            ${isLink ? '<span class="book-action-icon" title="é˜…è¯»">ğŸ“–</span>' : '<span class="book-action-icon" title="å¤åˆ¶">ğŸ“‹</span>'}
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
        }
        
// é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ‰§è¡Œ
// é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ‰§è¡Œ
window.onload = function() {
    // 1. ä»æœåŠ¡å™¨è·å–æœ€åé˜…è¯»è®°å½•
    fetch('/api/last_read')
        .then(res => res.json())
        .then(async data => { // æ³¨æ„è¿™é‡ŒåŠ äº† async
            const lastKey = data.key;
            
            if (lastKey) {
                // 2. å¡«å…¥ Key
                document.getElementById('key').value = lastKey;
                
                // 3. [æ–°å¢] ç²¾ç¡®è·å–å¯¹åº”çš„ Value å¹¶å¡«å…¥è¾“å…¥æ¡†
                try {
                    const valRes = await fetch('/api/get_value', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ key: lastKey })
                    });
                    const valData = await valRes.json();
                    if (valData.status === 'success') {
                        document.getElementById('value').value = valData.value;
                    }
                } catch(e) { console.error("è·å–Valueå¤±è´¥", e); }

                // 4. è§¦å‘æŸ¥æ‰¾ï¼Œæ˜¾ç¤ºåˆ—è¡¨
                doAction('find');
                
                const msgBox = document.getElementById('msgBox');
                msgBox.innerText = `â˜ï¸ äº‘ç«¯åŒæ­¥æˆåŠŸï¼Œå·²å®šä½åˆ°ï¼š${lastKey}`;
                msgBox.className = 'msg success';
                msgBox.style.display = 'block';
            } else {
                // 5. å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡æ¥ï¼Œå°±åˆ—å‡ºæ‰€æœ‰ä¹¦
                doAction('list');
            }
        })
        .catch(err => {
            console.error("æ— æ³•è¿æ¥æœåŠ¡å™¨è·å–åŒæ­¥ä¿¡æ¯");
            doAction('list');
        });
};
// === æ·±åº¦åˆ†æé€»è¾‘ ===
        function openInsight() {
            const modal = document.getElementById('insightModal');
            modal.style.display = 'flex';
            
            // åŠ è½½åŠ¨ç”»
            document.getElementById('st-books').innerText = '...';
            document.getElementById('heatmapGrid').innerHTML = '<div style="width:100%;text-align:center;font-size:12px;color:#999;line-height:60px;">æ­£åœ¨åˆ†ææœ¬åœ°æ•°æ®...</div>';

            fetch(`${API_URL}/api/analyze_stats`)
                .then(res => res.json())
                .then(res => {
                    if (res.status === 'success') {
                        renderStats(res.stats);
                    } else {
                        alert("åˆ†æå¤±è´¥");
                    }
                });
        }

        function closeInsight() {
            document.getElementById('insightModal').style.display = 'none';
        }

        function renderStats(stats) {
            // 1. æ¸²æŸ“æ•°å­—
            animateValue("st-books", 0, stats.books, 800);
            animateValue("st-words", 0, Math.round(stats.words / 10000), 1000); // è½¬ä¸ºä¸‡å­—
            animateValue("st-days", 0, stats.chapters, 800);

            // 2. æ¸²æŸ“çƒ­åŠ›å›¾ (ç®€å•çš„æŸ±çŠ¶å›¾)
            const grid = document.getElementById('heatmapGrid');
            grid.innerHTML = '';
            
            // æ‰¾å‡ºæœ€å¤§å€¼ç”¨äºå½’ä¸€åŒ–é«˜åº¦
            const maxCount = Math.max(...stats.heatmap.map(d => d.count)) || 1;
            
            stats.heatmap.forEach(d => {
                const bar = document.createElement('div');
                bar.className = 'heat-bar';
                // è®¡ç®—é«˜åº¦ç™¾åˆ†æ¯”ï¼Œæœ€å°‘ 10%
                const height = d.count > 0 ? (d.count / maxCount * 100) : 5; 
                bar.style.height = `${height}%`;
                
                // é¢œè‰²æ·±åº¦ï¼šè¯»å¾—è¶Šå¤šé¢œè‰²è¶Šæ·±
                const opacity = d.count > 0 ? 0.3 + (d.count / maxCount * 0.7) : 0.1;
                bar.style.backgroundColor = `rgba(102, 126, 234, ${opacity})`;
                
                bar.setAttribute('data-date', d.date.slice(5)); // åªæ˜¾ç¤º MM-DD
                bar.setAttribute('data-count', d.count);
                grid.appendChild(bar);
            });

            // 3. æ¸²æŸ“å…³é”®è¯
            const cloud = document.getElementById('tagsCloud');
            cloud.innerHTML = '';
            if (stats.keywords.length === 0) {
                cloud.innerHTML = '<span style="font-size:12px;color:#ccc">æš‚æ— è¶³å¤Ÿæ•°æ®åˆ†æ</span>';
            } else {
                stats.keywords.forEach((item, index) => {
                    const pill = document.createElement('span');
                    pill.className = `tag-pill top-${index+1}`;
                    pill.innerText = `${item[0]} (${item[1]})`;
                    cloud.appendChild(pill);
                });
            }
        }

        // æ•°å­—æ»šåŠ¨åŠ¨ç”»æ•ˆæœ
        function animateValue(id, start, end, duration) {
            const obj = document.getElementById(id);
            let startTimestamp = null;
            const step = (timestamp) => {
                if (!startTimestamp) startTimestamp = timestamp;
                const progress = Math.min((timestamp - startTimestamp) / duration, 1);
                obj.innerHTML = Math.floor(progress * (end - start) + start);
                if (progress < 1) {
                    window.requestAnimationFrame(step);
                }
            };
            window.requestAnimationFrame(step);
        }
        
        // ç‚¹å‡»é®ç½©å…³é—­
        document.getElementById('insightModal').addEventListener('click', function(e) {
            if (e.target === this) closeInsight();
        });
        // window.onload = () => 
    </script>
</body>
</html>