<!-- templates/admin.html -->
<!DOCTYPE html>
<html>
<head>
    <title>Admin Dashboard</title>
    <link rel="stylesheet" href="/purecss/pure2.1.css">
    <script src="/purecss/pure2.1.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .p-container { max-width: 1100px; margin: 20px auto; }
        .stats-card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .grid-2 { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; margin-bottom: 30px; }
        .user-detail-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #f0f0f0; }
        .history-tag { font-size: 11px; background: #eef2ff; color: #4f46e5; padding: 2px 6px; border-radius: 4px; }
    </style>
</head>
<body style="background: #f9fafb;">

<div class="p-container">
    <h1>ğŸ”§ ç®¡ç†å‘˜æ§åˆ¶å°</h1>

    <div class="grid-2">
        <!-- å…¨ç³»ç»Ÿæ´»è·ƒåº¦æŠ˜çº¿å›¾ -->
        <div class="stats-card">
            <h3>ğŸ“ˆ å…¨ç«™é˜…è¯»æ—¶é•¿è¶‹åŠ¿ (æœ€è¿‘30å¤©/å°æ—¶)</h3>
            <canvas id="activityChart" height="120"></canvas>
        </div>

        <!-- å¿«é€Ÿç»Ÿè®¡ -->
        <div class="stats-card" id="systemSummary">
            <h3>ğŸ“Š æ ¸å¿ƒæŒ‡æ ‡</h3>
            <div id="summaryContent">åŠ è½½ä¸­...</div>
        </div>
    </div>

    <!-- ç”¨æˆ·åˆ—è¡¨ -->
    <div class="p-card">
        <h3>ğŸ‘¥ ç”¨æˆ·ç®¡ç†</h3>
        <table class="p-table">
            <thead>
                <tr>
                    <th>ç”¨æˆ·å</th>
                    <th>è§’è‰²</th>
                    <th>æ“ä½œ</th>
                </tr>
            </thead>
            <tbody id="userTable"></tbody>
        </table>
    </div>
</div>

<!-- ç”¨æˆ·è¯¦æƒ… Modal -->
<div id="userDetailModal" class="p-modal">
    <div class="p-modal-content" style="max-width: 500px;">
        <h3 id="detailTitle">ç”¨æˆ·è¯¦æƒ…</h3>
        <div id="detailContent">
            <!-- JS å¡«å……å†…å®¹ -->
        </div>
        <div style="text-align:right; margin-top:20px;">
            <button class="p-btn p-btn-primary" onclick="PureUI.modal.close('userDetailModal')">å…³é—­</button>
        </div>
    </div>
</div>

<script>
    // admin.html é‡Œçš„ script éƒ¨åˆ†

// æ–°å¢ï¼šåŠ è½½å…¨ç«™æ ¸å¿ƒæŒ‡æ ‡
async function loadSystemSummary() {
    try {
        const res = await fetch('/api/admin/system_summary');
        const d = await res.json();
        
        if (d.status === 'success') {
            document.getElementById('summaryContent').innerHTML = `
                <div class="user-detail-row"><span>å…¨ç«™æ€»ç”¨æˆ·:</span> <b>${d.users} äºº</b></div>
                <div class="user-detail-row"><span>å…¨ç«™æ€»è—ä¹¦:</span> <b>${d.books} æœ¬</b></div>
                <div class="user-detail-row"><span>ç´¯è®¡é˜…è¯»æ—¶é•¿:</span> <b>${d.total_time_hr} å°æ—¶</b></div>
                <div class="user-detail-row"><span>ç´¯è®¡é˜…è¯»å­—æ•°:</span> <b>${d.total_words_wan} ä¸‡å­—</b></div>
                <div class="user-detail-row" style="border:none; margin-top:10px;">
                    <button class="p-btn p-btn-sm p-btn-danger" style="width:100%" onclick="clearAllCache()">ğŸ—‘ï¸ æ¸…ç†ç³»ç»Ÿç¼“å­˜</button>
                </div>
            `;
        }
    } catch (e) {
        document.getElementById('summaryContent').innerText = "åŠ è½½å¤±è´¥";
    }
}

// é¡ºä¾¿è¡¥ä¸€ä¸ªæ¸…ç†ç¼“å­˜çš„é€»è¾‘
async function clearAllCache() {
    if(confirm("ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰çˆ¬è™«ç¼“å­˜å—ï¼Ÿè¿™ä¼šå¯¼è‡´ä¸‹æ¬¡é˜…è¯»åŠ è½½å˜æ…¢ã€‚")) {
        const res = await fetch('/api/admin/clear_cache', {method: 'POST'});
        const d = await res.json();
        alert(d.msg || "å·²æ¸…ç©º");
    }
}
    // 1. åˆå§‹åŒ–æŠ˜çº¿å›¾
    async function initChart() {
        const res = await fetch('/api/admin/activity_stats');
        const data = await res.json();
        
        new Chart(document.getElementById('activityChart'), {
            type: 'line',
            data: {
                labels: data.labels,
                datasets: [{
                    label: 'æ€»é˜…è¯»å°æ—¶',
                    data: data.values,
                    borderColor: '#4f46e5',
                    backgroundColor: 'rgba(79, 70, 229, 0.1)',
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                plugins: { legend: { display: false } },
                scales: { y: { beginAtZero: true } }
            }
        });
    }

    // 2. åŠ è½½ç”¨æˆ·åˆ—è¡¨
    async function loadUsers() {
        const res = await fetch('/api/admin/users');
        const data = await res.json();
        const t = document.getElementById('userTable');
        
        t.innerHTML = data.users.map(u => `
            <tr>
                <td><b>${u.username}</b></td>
                <td><span class="p-tag">${u.role}</span></td>
                <td>
                    <button class="p-btn p-btn-sm" onclick="viewUserDetail('${u.username}')">ğŸ” æ•°æ®è¯¦æƒ…</button>
                    <button class="p-btn p-btn-sm p-btn-outline" onclick="setRole('${u.username}', 'pro')">è®¾ä¸ºPro</button>
                </td>
            </tr>
        `).join('');
    }

    // 3. æŸ¥çœ‹ç”¨æˆ·è¯¦æƒ…
    async function viewUserDetail(username) {
        const res = await fetch(`/api/admin/user_detail/${username}`);
        const json = await res.json();
        const d = json.data;
        
        document.getElementById('detailTitle').innerText = `ğŸ“Š ç”¨æˆ·: ${d.username}`;
        
        let historyHtml = d.history.map(h => `
            <div class="user-detail-row">
                <span style="font-size:13px; color:#333;">${h.book_name}</span>
                <span class="history-tag">${h.title.slice(0,15)}...</span>
            </div>
        `).join('');

        document.getElementById('detailContent').innerHTML = `
            <div class="user-detail-row"><span>è—ä¹¦æ€»é‡:</span> <b>${d.total_books} æœ¬</b></div>
            <div class="user-detail-row"><span>ç´¯è®¡æ—¶é•¿:</span> <b>${(d.total_time_min/60).toFixed(1)} å°æ—¶</b></div>
            <div class="user-detail-row"><span>ç´¯è®¡é˜…è¯»:</span> <b>${(d.total_words/10000).toFixed(2)} ä¸‡å­—</b></div>
            <h4 style="margin: 20px 0 10px 0;">â³ æœ€è¿‘é˜…è¯» (Top 5)</h4>
            ${historyHtml || '<p style="color:#999">æš‚æ— å†å²è®°å½•</p>'}
        `;
        
        PureUI.modal.open('userDetailModal');
    }

    // åˆå§‹åŒ–
    // ä¿®æ”¹åçš„åˆå§‹åŒ–
    window.onload = () => {
        initChart();          // åŠ è½½æŠ˜çº¿å›¾
        loadUsers();          // åŠ è½½ç”¨æˆ·åˆ—è¡¨
        loadSystemSummary();  // åŠ è½½æ ¸å¿ƒæŒ‡æ ‡ <-- è¡¥ä¸Šè¿™ä¸€è¡Œ
    };
</script>
</body>
</html>