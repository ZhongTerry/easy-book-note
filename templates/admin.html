<!-- templates/admin.html -->
<!DOCTYPE html>
<html>
<head>
    <title>Admin Dashboard</title>
    <link rel="stylesheet" href="/purecss/pure2.1.css">
    <script src="/purecss/pure2.1.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .p-container { max-width: 1200px; margin: 20px auto; }
        .stats-card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .grid-2 { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; margin-bottom: 20px; }
        .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        
        .user-detail-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #f0f0f0; }
        .history-tag { font-size: 11px; background: #eef2ff; color: #4f46e5; padding: 2px 6px; border-radius: 4px; }
        
        /* é›†ç¾¤çŠ¶æ€å°åœ†ç‚¹ */
        .status-dot { display: inline-block; width: 8px; height: 8px; border-radius: 50%; margin-right: 5px; }
        .status-online { background-color: #10b981; box-shadow: 0 0 5px #10b981; }
        .status-warning { background-color: #f59e0b; }
        .status-offline { background-color: #ef4444; }

        /* è¿›åº¦æ¡ */
        .load-bar-bg { height: 6px; background: #f3f4f6; border-radius: 3px; overflow: hidden; margin-top: 5px; }
        .load-bar-fill { height: 100%; background: #4f46e5; transition: width 0.3s; }
    </style>
</head>
<body style="background: #f9fafb;">

<div class="p-container">
    <!-- é¡¶æ  -->
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
        <div style="display:flex; align-items:center; gap:10px;">
            <h1 style="margin: 0;">ğŸ”§ ç®¡ç†å‘˜æ§åˆ¶å°</h1>
            <span class="p-tag p-tag-blue" id="clusterStatusTag">é›†ç¾¤ç›‘æ§ä¸­...</span>
        </div>
        <a href="/" class="p-btn p-btn-outline" style="text-decoration: none; border-radius: 20px; padding: 6px 15px; font-size: 13px;">
            ğŸ  è¿”å›ä¹¦æ¶
        </a>
    </div>

    <!-- ç¬¬ä¸€æ’ï¼šæ ¸å¿ƒæ•°æ® -->
    <div class="grid-3">
        <!-- 1. å…¨ç«™æ•°æ® -->
        <div class="stats-card" id="systemSummary">
            <h3>ğŸ“Š æ ¸å¿ƒæŒ‡æ ‡</h3>
            <div id="summaryContent" style="font-size:13px; color:#666;">åŠ è½½ä¸­...</div>
        </div>
        
        <!-- 2. é›†ç¾¤æ¦‚è§ˆ -->
        <div class="stats-card">
            <h3>ğŸŒ å…¨çƒçˆ¬è™«ç½‘ç»œ</h3>
            <div style="display:flex; justify-content:space-between; align-items:center; margin-top:15px;">
                <div style="text-align:center">
                    <div style="font-size:24px; font-weight:bold; color:#10b981" id="onlineNodes">-</div>
                    <div style="font-size:12px; color:#666">åœ¨çº¿èŠ‚ç‚¹</div>
                </div>
                <div style="text-align:center">
                    <div style="font-size:24px; font-weight:bold; color:#4f46e5" id="totalTasks">-</div>
                    <div style="font-size:12px; color:#666">å¹¶å‘ä»»åŠ¡</div>
                </div>
                <div style="text-align:center">
                    <div style="font-size:24px; font-weight:bold; color:#f59e0b" id="avgCpu">-</div>
                    <div style="font-size:12px; color:#666">å¹³å‡è´Ÿè½½%</div>
                </div>
            </div>
            <div style="margin-top:15px; font-size:12px; color:#888;" id="regionInfo">
                åŒºåŸŸåˆ†å¸ƒ: CN(0) | GLOBAL(0)
            </div>
        </div>

        <!-- 3. ç¼“å­˜æ§åˆ¶ -->
        <div class="stats-card" style="display:flex; flex-direction:column; justify-content:center; align-items:center; gap:15px;">
            <button class="p-btn p-btn-danger" onclick="clearAllCache()" style="width:80%">ğŸ—‘ï¸ æ¸…ç©ºæ‰€æœ‰ç¼“å­˜</button>
            <div style="font-size:12px; color:#999; text-align:center;">
                å½“çˆ¬è™«æ•°æ®å‡ºç°ä¹±ç æˆ–æ›´æ–°ä¸åŠæ—¶æ—¶ä½¿ç”¨ã€‚<br>
                å½“å‰ç¼“å­˜å¤§å°: <span id="cacheSize">-</span> MB
            </div>
        </div>
    </div>

    <!-- è‡ªé€‚åº”æƒé‡ç³»ç»Ÿç›‘æ§ -->
    <div class="stats-card" style="margin-bottom: 20px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <h3>âš–ï¸ è‡ªé€‚åº”æƒé‡ç³»ç»Ÿ</h3>
            <div style="display: flex; gap: 10px; align-items: center;">
                <span class="p-tag p-tag-blue" style="font-size: 11px;">EWMA Î±=0.15</span>
                <button class="p-btn p-btn-sm p-btn-outline" onclick="openWeightResetModal()" style="font-size: 11px; padding: 4px 10px;">
                    âš ï¸ é‡ç½®æƒé‡
                </button>
            </div>
        </div>
        
        <div id="weightSystemContent" style="min-height: 100px;">
            <div style="text-align:center; color:#999; padding:30px;">
                <div style="font-size:14px; margin-bottom:10px;">ğŸ“Š åŠ è½½æƒé‡æ•°æ®ä¸­...</div>
                <div style="font-size:12px; color:#ccc;">éœ€è¦Redisé›†ç¾¤æ¨¡å¼æ”¯æŒ</div>
            </div>
        </div>
        
        <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #f0f0f0; display: flex; justify-content: space-between; align-items: center;">
            <div style="font-size: 12px; color: #666;">
                <span style="color: #10b981;">â—</span> æå¿« &lt;500ms
                <span style="color: #4f46e5; margin-left: 10px;">â—</span> æ­£å¸¸ &lt;2s
                <span style="color: #f59e0b; margin-left: 10px;">â—</span> è¾ƒæ…¢ &lt;5s
                <span style="color: #ef4444; margin-left: 10px;">â—</span> å¾ˆæ…¢ &gt;5s
            </div>
            <button class="p-btn p-btn-sm p-btn-outline" onclick="loadLatencyStats()" style="font-size: 12px;">ğŸ”„ åˆ·æ–°</button>
        </div>
    </div>
    <!-- admin.html -->

<!-- åœ¨ grid-3 ä¸‹æ–¹æˆ–è€…åˆé€‚çš„ä½ç½®æ’å…¥ -->
<div class="p-card">
    <h3>ğŸš€ å…¨ç½‘ä¸€é”®æµ‹é€Ÿ</h3>
    <div style="display:flex; gap:10px; margin-bottom:15px;">
        <input type="text" id="speedUrl" class="p-input" placeholder="è¾“å…¥æµ‹è¯• URL (ä¾‹å¦‚ https://www.google.com)" value="https://www.baidu.com">
        <button class="p-btn p-btn-primary" onclick="startSpeedTest()" id="btnSpeed">å¼€å§‹æµ‹é€Ÿ</button>
    </div>
    
    <table class="p-table">
        <thead>
            <tr>
                <th>èŠ‚ç‚¹åç§°</th>
                <th>åŒºåŸŸ</th>
                <th>HTTP çŠ¶æ€</th>
                <th>è€—æ—¶ (ms)</th>
                <th>å“åº”å¤§å°</th>
            </tr>
        </thead>
        <tbody id="speedResults">
            <tr><td colspan="5" style="text-align:center;color:#999">æš‚æ— æµ‹è¯•æ•°æ®</td></tr>
        </tbody>
    </table>
</div>

<script>
    // admin.html <script> éƒ¨åˆ†

let currentTestId = null;
let speedTimer = null;

async function startSpeedTest() {
    const url = document.getElementById('speedUrl').value;
    if(!url) return alert("è¯·è¾“å…¥ URL");
    
    const btn = document.getElementById('btnSpeed');
    btn.disabled = true;
    btn.innerText = "å‡†å¤‡ä¸­...";
    document.getElementById('speedResults').innerHTML = '<tr><td colspan="5" style="text-align:center;color:#666">â³ æŒ‡ä»¤å·²ä¸‹å‘ï¼Œç­‰å¾…å“åº”...</td></tr>';
    
    try {
        const res = await fetch('/api/admin/speedtest/start', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({url})
        });
        const json = await res.json();
        
        if (json.status === 'success') {
            currentTestId = json.test_id;
            // å¼€å§‹è½®è¯¢
            if(speedTimer) clearInterval(speedTimer);
            speedTimer = setInterval(pollSpeedResults, 800); // 0.8ç§’åˆ·æ–°ä¸€æ¬¡
        } else {
            alert("å¯åŠ¨å¤±è´¥: " + json.msg);
            resetSpeedBtn();
        }
    } catch(e) {
        alert("ç½‘ç»œé”™è¯¯");
        resetSpeedBtn();
    }
}

function resetSpeedBtn() {
    const btn = document.getElementById('btnSpeed');
    btn.disabled = false;
    btn.innerText = "å¼€å§‹æµ‹é€Ÿ";
    if(speedTimer) clearInterval(speedTimer);
}

async function pollSpeedResults() {
    if(!currentTestId) return;
    
    try {
        const res = await fetch(`/api/admin/speedtest/results/${currentTestId}`);
        const json = await res.json();
        
        if (json.status === 'success') {
            const info = json.result; // æ³¨æ„ï¼šåç«¯åŒ…äº†ä¸€å±‚ result
            const list = info.data;
            const btn = document.getElementById('btnSpeed');
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            btn.innerText = `æµ‹é€Ÿä¸­ (${info.received}/${info.total}) ${info.elapsed}s`;
            
            // æ¸²æŸ“è¡¨æ ¼
            if (list.length > 0) {
                document.getElementById('speedResults').innerHTML = list.map(item => {
                    let latencyColor = 'green';
                    if (item.latency > 1000) latencyColor = 'orange';
                    if (item.latency > 3000 || item.error) latencyColor = 'red';
                    
                    const statusDisplay = item.error ? `<span style="color:red">Error</span>` : `<span class="p-tag">${item.status_code}</span>`;
                    
                    return `
                    <tr>
                        <td><b>${item.worker_name}</b></td>
                        <td><span class="p-badge">${item.region}</span></td>
                        <td>${statusDisplay}</td>
                        <td style="color:${latencyColor}; font-weight:bold;">${item.latency} ms</td>
                        <td>${item.size ? (item.size/1024).toFixed(2) + ' KB' : '-'}</td>
                    </tr>
                    `;
                }).join('');
            }

            // === [æ ¸å¿ƒ] ç»“æŸåˆ¤å®š ===
            if (info.state === 'finished' || info.state === 'timeout') {
                clearInterval(speedTimer);
                btn.disabled = false;
                
                if (info.state === 'finished') {
                    btn.innerText = `âœ… å®Œæˆ (${info.received}/${info.total})`;
                    btn.className = "p-btn p-btn-success";
                } else {
                    btn.innerText = `âš ï¸ è¶…æ—¶ç»“æŸ (${info.received}/${info.total})`;
                    btn.className = "p-btn p-btn-warning";
                }
                
                // 3ç§’åæ¢å¤æŒ‰é’®åŸå§‹çŠ¶æ€
                setTimeout(() => {
                    btn.innerText = "å¼€å§‹æµ‹é€Ÿ";
                    btn.className = "p-btn p-btn-primary";
                }, 3000);
            }
        }
    } catch(e) {
        console.error(e);
        // resetSpeedBtn(); // é‡åˆ°ç½‘ç»œé”™è¯¯å…ˆåˆ«æ€¥ç€åœï¼Œå¯èƒ½åªæ˜¯æŠ–åŠ¨
    }
}
</script>
    <!-- ç¬¬äºŒæ’ï¼šå›¾è¡¨ -->
    <div class="stats-card" style="margin-bottom: 20px;">
        <h3>ğŸ“ˆ å…¨ç«™é˜…è¯»æ—¶é•¿è¶‹åŠ¿ (æœ€è¿‘30å¤©)</h3>
        <div style="position: relative; height: 300px; width: 100%;">
            <canvas id="activityChart"></canvas>
        </div>
    </div>

    <!-- ç¬¬ä¸‰æ’ï¼šé›†ç¾¤èŠ‚ç‚¹åˆ—è¡¨ -->
    <div class="p-card">
        <h3>ğŸ–¥ï¸ é›†ç¾¤èŠ‚ç‚¹è¯¦æƒ… (å®æ—¶åˆ·æ–°)</h3>
        <table class="p-table">
            <thead>
                <tr>
                    <th width="20%">èŠ‚ç‚¹åç§° / IP</th>
                    <th width="15%">çŠ¶æ€ / å»¶è¿Ÿ</th>
                    <th width="15%">åŒºåŸŸ</th>
                    <th width="30%">ä»»åŠ¡å¹¶å‘ (Load)</th>
                    <th width="20%">èµ„æºå ç”¨ (CPU/Mem)</th>
                </tr>
            </thead>
            <tbody id="clusterTable">
                <tr><td colspan="5" style="text-align:center; color:#999;">æ­£åœ¨è¿æ¥ä¸»æ§èŠ‚ç‚¹...</td></tr>
            </tbody>
        </table>
    </div>

    <!-- ç¬¬å››æ’ï¼šç”¨æˆ·åˆ—è¡¨ -->
    <div class="p-card">
        <h3>ğŸ‘¥ ç”¨æˆ·ç®¡ç†</h3>
        <table class="p-table">
            <thead>
                <tr>
                    <th>ç”¨æˆ·å</th>
                    <th>è§’è‰²</th>
                    <th>æ“ä½œ</th>
                </tr>
            </thead>
            <tbody id="userTable"></tbody>
        </table>
    </div>
</div>

<!-- ç”¨æˆ·è¯¦æƒ… Modal -->
<div id="userDetailModal" class="p-modal">
    <div class="p-modal-content" style="max-width: 500px;">
        <h3 id="detailTitle">ç”¨æˆ·è¯¦æƒ…</h3>
        <div id="detailContent"></div>
        <div style="text-align:right; margin-top:20px;">
            <button class="p-btn p-btn-primary" onclick="PureUI.modal.close('userDetailModal')">å…³é—­</button>
        </div>
    </div>
</div>

<!-- æƒé‡ç¼–è¾‘æ¨¡æ€æ¡† -->
<div id="weightEditModal" class="p-modal">
    <div class="p-modal-content" style="max-width: 500px;">
        <h3>âœï¸ æ‰‹åŠ¨ç¼–è¾‘æƒé‡</h3>
        <div style="background: #fef3c7; border-left: 3px solid #f59e0b; padding: 12px; margin-bottom: 20px; border-radius: 4px; font-size: 13px;">
            âš ï¸ <b>è­¦å‘Š</b>ï¼šæ‰‹åŠ¨ä¿®æ”¹ä¼šè¦†ç›–EWMAè‡ªåŠ¨è®¡ç®—çš„å€¼ï¼Œè¯·è°¨æ…æ“ä½œ
        </div>
        
        <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 5px; font-size: 13px; font-weight: bold;">åŸŸå</label>
            <input type="text" id="editDomain" class="p-input" readonly style="background: #f9fafb;">
        </div>
        
        <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 5px; font-size: 13px; font-weight: bold;">èŠ‚ç‚¹UUID</label>
            <input type="text" id="editNodeUuid" class="p-input" readonly style="background: #f9fafb; font-family: monospace;">
        </div>
        
        <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 5px; font-size: 13px; font-weight: bold;">
                å»¶è¿Ÿæ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
                <span style="font-weight: normal; color: #666; font-size: 11px;">æç¤ºï¼š-1=é”™è¯¯èŠ‚ç‚¹, 100-5000=æ­£å¸¸èŒƒå›´</span>
            </label>
            <input type="number" id="editLatency" class="p-input" min="-1" max="60000" step="10" placeholder="è¾“å…¥å»¶è¿Ÿæ—¶é—´" oninput="updateWeightPreview()">
        </div>
        
        <div style="margin-bottom: 20px; padding: 10px; background: #f0f9ff; border-radius: 4px; font-size: 12px;">
            <div style="margin-bottom: 5px;"><b>æƒé‡ç³»æ•°é¢„è§ˆï¼š</b></div>
            <div id="weightPreview" style="font-size: 24px; font-weight: bold; color: #4f46e5;">-</div>
            <div style="margin-top: 5px; color: #666;">å»¶è¿Ÿè¶Šä½ï¼Œæƒé‡è¶Šé«˜ï¼ˆèŒƒå›´ï¼š0.1 - 3.0ï¼‰</div>
        </div>
        
        <div style="display: flex; gap: 10px; justify-content: flex-end;">
            <button class="p-btn p-btn-outline" onclick="PureUI.modal.close('weightEditModal')">å–æ¶ˆ</button>
            <button class="p-btn p-btn-primary" onclick="saveWeightEdit()">ğŸ’¾ ä¿å­˜</button>
        </div>
    </div>
</div>

<!-- æƒé‡é‡ç½®æ¨¡æ€æ¡† -->
<div id="weightResetModal" class="p-modal">
    <div class="p-modal-content" style="max-width: 450px;">
        <h3>âš ï¸ é‡ç½®æƒé‡æ•°æ®</h3>
        <div style="background: #fee2e2; border-left: 3px solid #ef4444; padding: 12px; margin-bottom: 20px; border-radius: 4px; font-size: 13px;">
            <b>å±é™©æ“ä½œ</b>ï¼šæ­¤æ“ä½œå°†åˆ é™¤æƒé‡æ•°æ®ï¼Œç³»ç»Ÿä¼šé‡æ–°å­¦ä¹ 
        </div>
        
        <div style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 10px; font-size: 13px; font-weight: bold;">é€‰æ‹©é‡ç½®èŒƒå›´</label>
            <select id="resetScope" class="p-input" style="width: 100%;" onchange="updateResetDomainInput()">
                <option value="all">é‡ç½®æ‰€æœ‰åŸŸåçš„æƒé‡</option>
                <option value="domain">é‡ç½®æŒ‡å®šåŸŸåçš„æƒé‡</option>
            </select>
        </div>
        
        <div id="resetDomainInput" style="margin-bottom: 20px; display: none;">
            <label style="display: block; margin-bottom: 5px; font-size: 13px; font-weight: bold;">åŸŸå</label>
            <input type="text" id="resetDomain" class="p-input" placeholder="ä¾‹å¦‚ï¼šwww.biquge.com">
        </div>
        
        <div style="display: flex; gap: 10px; justify-content: flex-end;">
            <button class="p-btn p-btn-outline" onclick="PureUI.modal.close('weightResetModal')">å–æ¶ˆ</button>
            <button class="p-btn p-btn-danger" onclick="confirmWeightReset()">ğŸ—‘ï¸ ç¡®è®¤é‡ç½®</button>
        </div>
    </div>
</div>

<script>
    // --- 1. å…¨ç«™æ ¸å¿ƒæŒ‡æ ‡ ---
    async function loadSystemSummary() {
        try {
            const res = await fetch('/api/admin/system_summary');
            const d = await res.json();
            if (d.status === 'success') {
                document.getElementById('summaryContent').innerHTML = `
                    <div class="user-detail-row"><span>æ€»ç”¨æˆ·:</span> <b>${d.users}</b></div>
                    <div class="user-detail-row"><span>æ€»ä¹¦ç±:</span> <b>${d.books}</b></div>
                    <div class="user-detail-row"><span>æ€»æ—¶é•¿:</span> <b>${d.total_time_hr}h</b></div>
                    <div class="user-detail-row"><span>æ€»å­—æ•°:</span> <b>${d.total_words_wan}w</b></div>
                `;
            }
        } catch (e) {}
    }
    
    async function loadDashboardStats() {
        try {
            const res = await fetch('/api/admin/dashboard');
            const d = await res.json();
            if(d.status === 'success') {
                document.getElementById('cacheSize').innerText = d.stats.cache_size_mb;
            }
        } catch(e) {}
    }

    // --- 2. é›†ç¾¤ç›‘æ§ (æ ¸å¿ƒ) ---
    async function loadClusterStatus() {
        try {
            const res = await fetch('/api/admin/cluster_status');
            const json = await res.json();
            
            if (json.status !== 'success') return;
            
            const s = json.summary;
            
            // æ›´æ–°é¡¶éƒ¨æ¦‚è§ˆ
            document.getElementById('onlineNodes').innerText = s.online_nodes + '/' + s.total_nodes;
            document.getElementById('totalTasks').innerText = s.total_tasks;
            document.getElementById('avgCpu').innerText = s.avg_cpu + '%';
            document.getElementById('regionInfo').innerText = `åˆ†å¸ƒ: CN(${s.regions.CN}) | GLOBAL(${s.regions.GLOBAL})`;
            
            document.getElementById('clusterStatusTag').className = s.online_nodes > 0 ? 'p-tag p-tag-green' : 'p-tag p-tag-red';
            document.getElementById('clusterStatusTag').innerText = s.online_nodes > 0 ? 'é›†ç¾¤è¿è¡Œä¸­' : 'æ— å¯ç”¨èŠ‚ç‚¹';

            // æ›´æ–°è¡¨æ ¼
            const rows = json.nodes.map(n => {
                let statusClass = 'status-offline';
                let statusText = 'ç¦»çº¿';
                if (n.status === 'online') { statusClass = 'status-online'; statusText = 'åœ¨çº¿'; }
                if (n.status === 'warning') { statusClass = 'status-warning'; statusText = 'å»¶è¿Ÿ'; }
                
                let loadColor = '#4f46e5';
                if (n.load_pct > 80) loadColor = '#ef4444';

                return `
                <tr>
                    <td>
                        <div style="font-weight:bold;">${n.name}</div>
                        <div style="font-size:11px; color:#999;">${n.ip}</div>
                    </td>
                    <td>
                        <div style="display:flex; align-items:center;">
                            <span class="status-dot ${statusClass}"></span>
                            <span>${statusText}</span>
                            <span style="font-size:11px; color:#999; margin-left:5px;">(${n.lag})</span>
                        </div>
                    </td>
                    <td><span class="p-tag">${n.region}</span></td>
                    <td>
                        <div style="display:flex; justify-content:space-between; font-size:11px;">
                            <span>${n.load} ä»»åŠ¡</span>
                            <span>${n.load_pct}%</span>
                        </div>
                        <div class="load-bar-bg">
                            <div class="load-bar-fill" style="width:${n.load_pct}%; background:${loadColor}"></div>
                        </div>
                    </td>
                    <td style="font-size:12px;">
                        CPU: <b>${n.cpu}%</b> <span style="color:#ddd">|</span> Mem: <b>${n.mem}%</b>
                    </td>
                </tr>
                `;
            }).join('');
            
            document.getElementById('clusterTable').innerHTML = rows || '<tr><td colspan="5" style="text-align:center; padding:20px;">æš‚æ— èŠ‚ç‚¹æ¥å…¥ï¼Œæ­£åœ¨ç­‰å¾… Worker å¯åŠ¨...</td></tr>';
            
        } catch (e) {
            console.error("Cluster Load Error:", e);
        }
    }

    // --- 3. å›¾è¡¨ ---
    async function initChart() {
        const res = await fetch('/api/admin/activity_stats');
        const data = await res.json();
        
        new Chart(document.getElementById('activityChart'), {
            type: 'line',
            data: {
                labels: data.labels,
                datasets: [{
                    label: 'æ€»é˜…è¯»å°æ—¶',
                    data: data.values,
                    borderColor: '#4f46e5',
                    backgroundColor: 'rgba(79, 70, 229, 0.1)',
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                plugins: { legend: { display: false } },
                scales: { y: { beginAtZero: true } },
                maintainAspectRatio: false
            }
        });
    }

    // --- 4. ç”¨æˆ·åˆ—è¡¨ & è¯¦æƒ… ---
    async function loadUsers() {
        const res = await fetch('/api/admin/users');
        const data = await res.json();
        const t = document.getElementById('userTable');
        t.innerHTML = data.users.map(u => `
            <tr>
                <td><b>${u.username}</b></td>
                <td><span class="p-tag">${u.role}</span></td>
                <td><button class="p-btn p-btn-sm" onclick="viewUserDetail('${u.username}')">ğŸ” è¯¦æƒ…</button></td>
            </tr>
        `).join('');
    }

    async function viewUserDetail(username) {
        const res = await fetch(`/api/admin/user_detail/${username}`);
        const json = await res.json();
        const d = json.data;
        document.getElementById('detailTitle').innerText = `ğŸ“Š ç”¨æˆ·: ${d.username}`;
        let historyHtml = d.history.map(h => `<div class="user-detail-row"><span style="font-size:13px;">${h.book_name}</span><span class="history-tag">${h.title.slice(0,10)}...</span></div>`).join('');
        document.getElementById('detailContent').innerHTML = `
            <div class="user-detail-row"><span>è—ä¹¦:</span> <b>${d.total_books}</b></div>
            <div class="user-detail-row"><span>æ—¶é•¿:</span> <b>${(d.total_time_min/60).toFixed(1)}h</b></div>
            <div class="user-detail-row"><span>å­—æ•°:</span> <b>${(d.total_words/10000).toFixed(2)}w</b></div>
            <h4 style="margin:15px 0 5px;">â³ æœ€è¿‘é˜…è¯»</h4>${historyHtml}`;
        PureUI.modal.open('userDetailModal');
    }

    async function clearAllCache() {
        if(confirm("ç¡®å®šæ¸…ç©ºï¼Ÿ")) {
            await fetch('/api/admin/clear_cache', {method: 'POST'});
            alert("å·²æ¸…ç©º");
            loadDashboardStats(); // åˆ·æ–°ç¼“å­˜å¤§å°æ˜¾ç¤º
        }
    }

    // --- 5. æƒé‡ç³»ç»Ÿç›‘æ§ ---
    async function loadLatencyStats() {
        try {
            const res = await fetch('/api/cluster/latency_stats');
            const json = await res.json();
            
            if (json.status === 'error') {
                document.getElementById('weightSystemContent').innerHTML = `
                    <div style="text-align:center; color:#f59e0b; padding:30px;">
                        <div style="font-size:14px; margin-bottom:10px;">âš ï¸ ${json.msg}</div>
                        <div style="font-size:12px; color:#999;">è¯·ç¡®ä¿å·²é…ç½®REDIS_URLç¯å¢ƒå˜é‡</div>
                    </div>
                `;
                return;
            }
            
            const data = json.data;
            const domains = Object.keys(data);
            
            if (domains.length === 0) {
                document.getElementById('weightSystemContent').innerHTML = `
                    <div style="text-align:center; color:#999; padding:30px;">
                        <div style="font-size:14px; margin-bottom:10px;">ğŸ“­ æš‚æ— æƒé‡æ•°æ®</div>
                        <div style="font-size:12px; color:#ccc;">ç­‰å¾…èŠ‚ç‚¹å¼€å§‹çˆ¬å–ä»»åŠ¡åä¼šè‡ªåŠ¨è®°å½•</div>
                    </div>
                `;
                return;
            }
            
            // æ¸²æŸ“æƒé‡æ•°æ®
            let html = '<div style="display: grid; gap: 15px;">';
            
            for (const domain of domains.slice(0, 5)) { // åªæ˜¾ç¤ºå‰5ä¸ªåŸŸå
                const nodes = data[domain];
                const nodeList = Object.entries(nodes);
                
                html += `
                    <div style="background: #f9fafb; padding: 15px; border-radius: 8px; border-left: 3px solid #4f46e5;">
                        <div style="font-weight: bold; margin-bottom: 10px; font-size: 13px; color: #374151;">
                            ğŸŒ ${domain}
                        </div>
                        <div style="display: grid; gap: 8px;">
                `;
                
                for (const [nodeUuid, stats] of nodeList.slice(0, 3)) { // æ¯ä¸ªåŸŸåæœ€å¤šæ˜¾ç¤º3ä¸ªèŠ‚ç‚¹
                    const statusColor = 
                        stats.latency_ms < 500 ? '#10b981' : 
                        stats.latency_ms < 2000 ? '#4f46e5' : 
                        stats.latency_ms < 5000 ? '#f59e0b' : '#ef4444';
                    
                    const nodeShortId = nodeUuid.substring(0, 8);
                    
                    html += `
                        <div style="display: flex; justify-content: space-between; align-items: center; font-size: 12px;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span style="color: ${statusColor}; font-size: 16px;">â—</span>
                                <span style="color: #6b7280; font-family: monospace;">${nodeShortId}</span>
                            </div>
                            <div style="display: flex; gap: 12px; align-items: center;">
                                <span style="color: ${statusColor}; font-weight: bold;">${Math.round(stats.latency_ms)}ms</span>
                                <span style="color: #9ca3af;">Ã—${stats.weight_coefficient}</span>
                                <span class="p-badge" style="font-size: 10px; background: ${statusColor}20; color: ${statusColor}; border: 1px solid ${statusColor}40;">
                                    ${stats.status}
                                </span>
                                <button class="p-btn p-btn-outline" style="padding: 2px 8px; font-size: 11px;" 
                                    onclick="editNodeWeight('${domain}', '${nodeUuid}', ${stats.latency_ms})" 
                                    title="æ‰‹åŠ¨ç¼–è¾‘æƒé‡">
                                    âœï¸
                                </button>
                            </div>
                        </div>
                    `;
                }
                
                if (nodeList.length > 3) {
                    html += `<div style="font-size: 11px; color: #9ca3af; text-align: right;">è¿˜æœ‰ ${nodeList.length - 3} ä¸ªèŠ‚ç‚¹...</div>`;
                }
                
                html += '</div></div>';
            }
            
            if (domains.length > 5) {
                html += `<div style="font-size: 12px; color: #9ca3af; text-align: center; padding-top: 5px;">
                    è¿˜æœ‰ ${domains.length - 5} ä¸ªåŸŸåçš„æƒé‡æ•°æ®æœªæ˜¾ç¤º
                </div>`;
            }
            
            html += '</div>';
            
            document.getElementById('weightSystemContent').innerHTML = html;
            
        } catch(e) {
            console.error('åŠ è½½æƒé‡æ•°æ®å¤±è´¥:', e);
            document.getElementById('weightSystemContent').innerHTML = `
                <div style="text-align:center; color:#ef4444; padding:30px;">
                    <div style="font-size:14px; margin-bottom:10px;">âŒ åŠ è½½å¤±è´¥</div>
                    <div style="font-size:12px; color:#999;">${e.message}</div>
                </div>
            `;
        }
    }

    // åˆå§‹åŒ–
    window.onload = () => {
        initChart();
        loadUsers();
        loadSystemSummary();
        loadDashboardStats();
        loadLatencyStats(); // åŠ è½½æƒé‡æ•°æ®
        
        // ç«‹å³åŠ è½½ä¸€æ¬¡é›†ç¾¤çŠ¶æ€ï¼Œç„¶åæ¯ 3 ç§’åˆ·æ–°
        loadClusterStatus();
        setInterval(loadClusterStatus, 3000);
        
        // æ¯10ç§’åˆ·æ–°ä¸€æ¬¡æƒé‡æ•°æ®
        setInterval(loadLatencyStats, 10000);
    };

    // --- æƒé‡ç¼–è¾‘åŠŸèƒ½ ---
    
    // æ‰“å¼€æƒé‡ç¼–è¾‘æ¨¡æ€æ¡†
    function editNodeWeight(domain, nodeUuid, currentLatency) {
        document.getElementById('editDomain').value = domain;
        document.getElementById('editNodeUuid').value = nodeUuid;
        document.getElementById('editLatency').value = currentLatency;
        updateWeightPreview();
        PureUI.modal.open('weightEditModal');
    }

    // æ›´æ–°æƒé‡ç³»æ•°é¢„è§ˆ
    function updateWeightPreview() {
        const latency = parseFloat(document.getElementById('editLatency').value);
        if (isNaN(latency) || latency < -1) {
            document.getElementById('weightPreview').innerText = '-';
            return;
        }
        
        // ä½¿ç”¨å’Œåç«¯ç›¸åŒçš„è®¡ç®—é€»è¾‘
        let coefficient;
        if (latency === -1) {
            coefficient = 0.1;
        } else {
            coefficient = Math.max(0.1, Math.min(3.0, 1000.0 / Math.max(latency, 100)));
        }
        
        document.getElementById('weightPreview').innerText = coefficient.toFixed(3);
        document.getElementById('weightPreview').style.color = 
            coefficient >= 2.0 ? '#10b981' : 
            coefficient >= 1.0 ? '#4f46e5' : 
            coefficient >= 0.5 ? '#f59e0b' : '#ef4444';
    }

    // ä¿å­˜æƒé‡ç¼–è¾‘
    async function saveWeightEdit() {
        const domain = document.getElementById('editDomain').value;
        const nodeUuid = document.getElementById('editNodeUuid').value;
        const latencyMs = parseFloat(document.getElementById('editLatency').value);
        
        if (!domain || !nodeUuid || isNaN(latencyMs)) {
            alert('âŒ è¯·å¡«å†™å®Œæ•´çš„ä¿¡æ¯');
            return;
        }
        
        if (latencyMs < -1 || latencyMs > 60000) {
            alert('âŒ å»¶è¿Ÿæ—¶é—´å¿…é¡»åœ¨ -1 åˆ° 60000 ä¹‹é—´');
            return;
        }
        
        try {
            const res = await fetch('/api/cluster/latency_update', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ domain, node_uuid: nodeUuid, latency_ms: latencyMs })
            });
            
            const data = await res.json();
            
            if (res.ok && data.status === 'success') {
                alert('âœ… æƒé‡å·²æ›´æ–°ï¼');
                PureUI.modal.close('weightEditModal');
                loadLatencyStats(); // åˆ·æ–°æƒé‡æ•°æ®æ˜¾ç¤º
            } else {
                alert('âŒ æ›´æ–°å¤±è´¥ï¼š' + (data.msg || 'æœªçŸ¥é”™è¯¯'));
            }
        } catch(e) {
            console.error(e);
            alert('âŒ ç½‘ç»œé”™è¯¯ï¼š' + e.message);
        }
    }

    // æ‰“å¼€æƒé‡é‡ç½®æ¨¡æ€æ¡†
    function openWeightResetModal() {
        document.getElementById('resetScope').value = 'all';
        document.getElementById('resetDomainInput').style.display = 'none';
        document.getElementById('resetDomain').value = '';
        PureUI.modal.open('weightResetModal');
    }

    // æ›´æ–°é‡ç½®åŸŸåè¾“å…¥æ¡†çš„æ˜¾ç¤º
    function updateResetDomainInput() {
        const scope = document.getElementById('resetScope').value;
        if (scope === 'domain') {
            document.getElementById('resetDomainInput').style.display = 'block';
        } else {
            document.getElementById('resetDomainInput').style.display = 'none';
            document.getElementById('resetDomain').value = '';
        }
    }

    // ç¡®è®¤é‡ç½®æƒé‡
    async function confirmWeightReset() {
        const scope = document.getElementById('resetScope').value;
        const domain = document.getElementById('resetDomain').value;
        
        if (scope === 'domain' && !domain) {
            alert('âŒ è¯·è¾“å…¥è¦é‡ç½®çš„åŸŸå');
            return;
        }
        
        const confirmMsg = scope === 'all' 
            ? 'âš ï¸ ç¡®è®¤é‡ç½®æ‰€æœ‰åŸŸåçš„æƒé‡æ•°æ®å—ï¼Ÿ\næ­¤æ“ä½œä¸å¯æ¢å¤ï¼' 
            : `âš ï¸ ç¡®è®¤é‡ç½®åŸŸå ${domain} çš„æƒé‡æ•°æ®å—ï¼Ÿ\næ­¤æ“ä½œä¸å¯æ¢å¤ï¼`;
        
        if (!confirm(confirmMsg)) {
            return;
        }
        
        try {
            const payload = scope === 'all' ? {} : { domain };
            const res = await fetch('/api/cluster/latency_reset', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            
            const data = await res.json();
            
            if (res.ok && data.status === 'success') {
                alert('âœ… æƒé‡å·²é‡ç½®ï¼ç³»ç»Ÿå°†é‡æ–°å­¦ä¹ ');
                PureUI.modal.close('weightResetModal');
                loadLatencyStats(); // åˆ·æ–°æƒé‡æ•°æ®æ˜¾ç¤º
            } else {
                alert('âŒ é‡ç½®å¤±è´¥ï¼š' + (data.msg || 'æœªçŸ¥é”™è¯¯'));
            }
        } catch(e) {
            console.error(e);
            alert('âŒ ç½‘ç»œé”™è¯¯ï¼š' + e.message);
        }
    }
</script>
</body>
</html>