<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…¨ç½‘æœä¹¦ - Smart NoteDB</title>
    <link rel="stylesheet" href="/purecss/pure2.1.css">
    <script src="/purecss/pure2.1.js"></script>
    <link rel="icon" href="/static/icons/favicon.ico" type="image/x-icon">
    <style>
        /* ç»§æ‰¿ index.html çš„é…è‰²æ–¹æ¡ˆ */
        body {
            background: #f3f4f6;
            margin: 0;
            padding: 20px;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }
        
        /* é¡¶éƒ¨ç”¨æˆ·æ ï¼ˆä¸ index.html ä¸€è‡´ï¼‰*/
        #userBar {
            background: rgba(255,255,255,0.9);
            padding: 10px 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 14px;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
        }
        
        /* ä¸»å®¹å™¨ï¼ˆä¸ index.html ä¸€è‡´ï¼‰*/
        .container {
            max-width: 900px;
            margin: 80px auto 40px;
            background-color: #ffffff;
            padding: 40px;
            border-radius: 16px;
            box-shadow: 0 10px 40px -10px rgba(0,0,0,0.08);
            border: 1px solid #f1f5f9;
        }
        
        h1 {
            margin-top: 0;
            color: #1f2937;
            text-align: center;
            font-size: 26px;
            margin-bottom: 10px;
        }
        
        .subtitle {
            text-align: center;
            color: #6b7280;
            font-size: 14px;
            margin-bottom: 30px;
        }
        
        /* æœç´¢æ  */
        .search-box {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .search-box input {
            flex: 1;
        }
        
        /* åŠŸèƒ½é€‰é¡¹å¡ */
        .feature-tabs {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
            flex-wrap: wrap;
        }
        
        .feature-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
            color: #6b7280;
        }
        
        .feature-item input[type="checkbox"] {
            cursor: pointer;
        }
        
        /* æœç´¢å†å² */
        .history-section {
            margin-bottom: 20px;
        }
        
        .history-title {
            font-size: 13px;
            color: #6b7280;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .history-tags {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .history-tag {
            padding: 4px 12px;
            background: #f3f4f6;
            border-radius: 6px;
            font-size: 13px;
            color: #4b5563;
            cursor: pointer;
            transition: 0.2s;
            border: 1px solid #e5e7eb;
        }
        
        .history-tag:hover {
            background: #e5e7eb;
            border-color: #4f46e5;
        }
        
        .clear-history {
            font-size: 12px;
            color: #ef4444;
            cursor: pointer;
            text-decoration: underline;
        }
        
        /* ç»“æœåŒºåŸŸ */
        .results-area {
            min-height: 300px;
        }
        
        .result-item {
            padding: 16px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .result-item:hover {
            border-color: #4f46e5;
            box-shadow: 0 2px 8px rgba(79, 70, 229, 0.1);
            transform: translateX(2px);
        }
        
        .res-left {
            flex: 1;
        }
        
        .res-title {
            font-size: 16px;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 6px;
        }
        
        .res-author {
            color: #6b7280;
            font-size: 13px;
            margin-left: 8px;
        }
        
        .res-meta {
            display: flex;
            gap: 10px;
            align-items: center;
            font-size: 12px;
            color: #9ca3af;
        }
        
        .source-tag {
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
        }
        
        .tag-baidu { background: #dbeafe; color: #1e40af; }
        .tag-bing { background: #fef3c7; color: #92400e; }
        .tag-360 { background: #d1fae5; color: #065f46; }
        .tag-direct { background: #e0e7ff; color: #4338ca; }
        
        .res-url {
            font-family: monospace;
            color: #9ca3af;
            font-size: 11px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            max-width: 400px;
        }
        
        .res-action {
            color: #4f46e5;
            font-weight: 600;
            font-size: 14px;
            white-space: nowrap;
        }
        
        /* ç©ºçŠ¶æ€ */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #9ca3af;
        }
        
        .empty-state svg {
            width: 60px;
            height: 60px;
            margin-bottom: 15px;
            opacity: 0.4;
        }
        
        /* ç»Ÿè®¡ä¿¡æ¯ */
        .stats-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            margin-bottom: 15px;
            font-size: 13px;
            color: #6b7280;
        }
        
        /* æ’åºé€‰é¡¹ */
        .sort-options {
            display: flex;
            gap: 10px;
        }
        
        .sort-btn {
            padding: 4px 10px;
            font-size: 12px;
            background: #f3f4f6;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            cursor: pointer;
            transition: 0.2s;
            color: #6b7280;
        }
        
        .sort-btn.active {
            background: #4f46e5;
            color: white;
            border-color: #4f46e5;
        }
        
        /* ç§»åŠ¨ç«¯é€‚é… */
        @media (max-width: 640px) {
            .container {
                padding: 20px;
                margin-top: 60px;
            }
            
            h1 {
                font-size: 20px;
            }
            
            .search-box {
                flex-direction: column;
            }
            
            .feature-tabs {
                display: none; /* ç§»åŠ¨ç«¯éšè—é«˜çº§é€‰é¡¹ */
            }
            
            .res-url {
                max-width: 150px;
            }
            
            .stats-bar {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <!-- é¡¶éƒ¨ç”¨æˆ·æ  -->
    <div id="userBar">
        <div style="display: flex; align-items: center; gap: 10px;">
            <a href="/" style="text-decoration: none; color: #1f2937; font-weight: 600;">â† è¿”å›ä¹¦æ¶</a>
        </div>
        <div style="display: flex; gap: 10px; align-items: center;">
            <span id="userName" style="font-size: 13px; color: #6b7280;">Loading...</span>
        </div>
    </div>

    <div class="container">
        <h1>ğŸ” å…¨ç½‘æœä¹¦</h1>
        <p class="subtitle">èšåˆå¤šä¸ªæœç´¢å¼•æ“ï¼Œä¸€é”®æ‰¾ä¹¦</p>
        
        <!-- æœç´¢æ  -->
        <div class="search-box">
            <input 
                type="text" 
                id="searchInput" 
                class="p-input" 
                placeholder="è¾“å…¥ä¹¦åæˆ–ä½œè€…ï¼Œå¦‚ï¼šå‡¡äººä¿®ä»™ä¼ " 
                autofocus
                onkeydown="if(event.key==='Enter') doSearch()"
            >
            <button class="p-btn p-btn-primary" onclick="doSearch()">æœç´¢</button>
        </div>
        
        <!-- åŠŸèƒ½é€‰é¡¹ -->
        <div class="feature-tabs">
            <div class="feature-item">
                <input type="checkbox" id="autoSave" checked>
                <label for="autoSave">è‡ªåŠ¨ä¿å­˜åˆ°ä¹¦æ¶</label>
            </div>
            <div class="feature-item">
                <input type="checkbox" id="showUrl">
                <label for="showUrl">æ˜¾ç¤ºæºé“¾æ¥</label>
            </div>
            <div class="feature-item">
                <span style="color: #4b5563;">æœç´¢æºæ•°é‡: <strong id="sourceCount">3</strong></span>
            </div>
        </div>
        
        <!-- æœç´¢å†å² -->
        <div class="history-section" id="historySection">
            <div class="history-title">
                <span>æœ€è¿‘æœç´¢</span>
                <span class="clear-history" onclick="clearHistory()">æ¸…ç©º</span>
            </div>
            <div class="history-tags" id="historyTags">
                <!-- åŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>
        
        <!-- ç»“æœç»Ÿè®¡æ  -->
        <div class="stats-bar" id="statsBar" style="display: none;">
            <span>æ‰¾åˆ° <strong id="resultCount">0</strong> ä¸ªç»“æœ</span>
            <div class="sort-options">
                <span class="sort-btn active" onclick="sortResults('default')">é»˜è®¤æ’åº</span>
                <span class="sort-btn" onclick="sortResults('source')">æŒ‰æ¥æº</span>
            </div>
        </div>
        
        <!-- ç»“æœåŒºåŸŸ -->
        <div class="results-area">
            <div id="resultsContainer" class="empty-state">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="11" cy="11" r="8"/>
                    <path d="m21 21-4.35-4.35"/>
                </svg>
                <p style="font-size:14px; margin:0; color:#6b7280;">è¾“å…¥ä¹¦åå¼€å§‹æœç´¢</p>
                <p style="font-size:12px; margin-top:8px; color:#9ca3af;">æ”¯æŒä¹¦åã€ä½œè€…åæœç´¢</p>
            </div>
        </div>
    </div>
    
    <script>
        const API_URL = window.location.origin;
        let searchHistory = JSON.parse(localStorage.getItem('search_history') || '[]');
        let currentResults = [];

        function escapeHtml(str) {
            return String(str)
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#39;")
                .replace(/`/g, "&#96;");
        }
        
        // åˆå§‹åŒ–
        window.onload = function() {
            renderHistory();
            loadUserInfo();
        };
        
        // åŠ è½½ç”¨æˆ·ä¿¡æ¯
        async function loadUserInfo() {
            try {
                const res = await fetch('/api/me');
                const user = await res.json();
                if (user.username) {
                    document.getElementById('userName').innerText = user.username;
                }
            } catch(e) {}
        }
        
        // æ¸²æŸ“æœç´¢å†å²
        function renderHistory() {
            const container = document.getElementById('historyTags');
            if (searchHistory.length === 0) {
                document.getElementById('historySection').style.display = 'none';
                return;
            }
            
            document.getElementById('historySection').style.display = 'block';
            container.innerHTML = searchHistory.slice(0, 8).map(keyword => 
                `<span class="history-tag" onclick="searchFromHistory(${JSON.stringify(keyword)})">${escapeHtml(keyword)}</span>`
            ).join('');
        }
        
        // ä»å†å²æœç´¢
        function searchFromHistory(keyword) {
            document.getElementById('searchInput').value = keyword;
            doSearch();
        }
        
        // æ¸…ç©ºå†å²
        function clearHistory() {
            if (confirm('ç¡®å®šæ¸…ç©ºæœç´¢å†å²å—ï¼Ÿ')) {
                searchHistory = [];
                localStorage.setItem('search_history', '[]');
                renderHistory();
            }
        }
        
        // ä¿å­˜æœç´¢å†å²
        function saveHistory(keyword) {
            // å»é‡å¹¶å‰ç½®
            searchHistory = [keyword, ...searchHistory.filter(k => k !== keyword)].slice(0, 20);
            localStorage.setItem('search_history', JSON.stringify(searchHistory));
            renderHistory();
        }
        
        // æ‰§è¡Œæœç´¢
        async function doSearch() {
            const keyword = document.getElementById('searchInput').value.trim();
            if (!keyword) {
                alert('è¯·è¾“å…¥ä¹¦å');
                return;
            }
            
            // ä¿å­˜å†å²
            saveHistory(keyword);
            
            const container = document.getElementById('resultsContainer');
            const statsBar = document.getElementById('statsBar');
            
            container.innerHTML = `
                <div class="empty-state">
                    <div style="width:50px; height:50px; margin:0 auto 15px; border:3px solid #f3f4f6; border-top-color:#4f46e5; border-radius:50%; animation:spin 1s linear infinite;"></div>
                    <p style="font-size:14px; color:#4f46e5; font-weight:600;">ğŸ” æ­£åœ¨æœç´¢...</p>
                </div>
            `;
            statsBar.style.display = 'none';
            
            try {
                PureUI.loading.show('ğŸ” èšåˆæœç´¢ä¸­...');
                const res = await fetch(`${API_URL}/api/search_novel`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({keyword: keyword})
                });
                const json = await res.json();
                
                if (json.status === 'pending') {
                    await pollSearchTask(json.task_id);
                } else if (json.data) {
                    handleSearchResults(json.data);
                } else {
                    handleSearchResults([]);
                }
            } catch(e) {
                container.innerHTML = `
                    <div class="empty-state">
                        <p style="font-size:16px; color:#ef4444; margin-bottom:10px;">âŒ æœç´¢å¤±è´¥</p>
                        <p style="font-size:13px; color:#9ca3af;">è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–ç¨åé‡è¯•</p>
                    </div>
                `;
            } finally {
                PureUI.loading.hide();
            }
        }
        
        // æ¸²æŸ“ç»“æœ
        function renderResults(results) {
            const container = document.getElementById('resultsContainer');
            const showUrl = document.getElementById('showUrl').checked;
            
            container.innerHTML = results.map(item => {
                let tagClass = 'tag-360';
                if (item.source.includes('Baidu')) tagClass = 'tag-baidu';
                else if (item.source.includes('Bing')) tagClass = 'tag-bing';
                else if (item.source.includes('ä¹¦é¦™') || item.source.includes('ç¬”è¶£') || item.source.includes('Direct')) tagClass = 'tag-direct';
                
                const safeTitle = escapeHtml(item.title || '');
                const safeDesc = escapeHtml(item.description || '');
                const safeUrl = escapeHtml(item.url || '');
                const safeSource = escapeHtml(item.source || 'Unknown');
                const authorHtml = item.description ? `<span class="res-author">${safeDesc}</span>` : '';
                const urlHtml = showUrl ? `<span class="res-url">${safeUrl}</span>` : '';
                
                return `
                <div class="result-item" onclick="selectResult(${JSON.stringify(item.suggested_key || '')}, ${JSON.stringify(item.url || '')}, ${JSON.stringify(item.title || '')})">
                    <div class="res-left">
                        <div class="res-title">
                            ${safeTitle}
                            ${authorHtml}
                        </div>
                        <div class="res-meta">
                            <span class="source-tag ${tagClass}">${safeSource}</span>
                            ${urlHtml}
                        </div>
                    </div>
                    <div class="res-action">
                        é˜…è¯» â†’
                    </div>
                </div>`;
            }).join('');
        }
        
        // æ’åºç»“æœ
        function sortResults(type) {
            document.querySelectorAll('.sort-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            if (type === 'source') {
                currentResults.sort((a, b) => a.source.localeCompare(b.source));
            } else {
                // é»˜è®¤æ’åºï¼ˆä¿æŒåŸå§‹é¡ºåºï¼‰
                currentResults.sort((a, b) => 0);
            }
            
            renderResults(currentResults);
        }
        
        // é€‰æ‹©ç»“æœ
        async function selectResult(key, url, title) {
            const autoSave = document.getElementById('autoSave').checked;
            
            PureUI.loading.show('ğŸ” æ­£åœ¨è·å–ç›®å½•...');
            
            try {
                // 1. ä¿å­˜åˆ°ä¹¦æ¶
                if (autoSave) {
                    await fetch(`${API_URL}/insert`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ key: key, value: url, manual: true })
                    });
                }
                
                // 2. è·å–ç›®å½•ï¼Œæ‰¾åˆ°ç¬¬ä¸€ç« 
                const tocRes = await fetch(`${API_URL}/toc?url=${encodeURIComponent(url)}&key=${encodeURIComponent(key)}&api=1`);
                const tocData = await tocRes.json();
                
                let firstChapterUrl = url; // é»˜è®¤ä½¿ç”¨åŸå§‹URL
                
                if (tocData && tocData.chapters && tocData.chapters.length > 0) {
                    // æ‰¾åˆ°ç¬¬ä¸€ç« 
                    firstChapterUrl = tocData.chapters[0].url;
                    PureUI.loading.show('ğŸ“– æ­£åœ¨æ‰“å¼€ç¬¬ä¸€ç« ...');
                } else {
                    // å¦‚æœè·å–ç›®å½•å¤±è´¥ï¼Œç›´æ¥ç”¨åŸå§‹URL
                    console.warn('æ— æ³•è·å–ç›®å½•ï¼Œä½¿ç”¨åŸå§‹URL');
                }
                
                // 3. è·³è½¬åˆ°é˜…è¯»é¡µé¢
                if (autoSave) {
                    PureUI.toast('âœ… å·²ä¿å­˜åˆ°ä¹¦æ¶');
                }
                
                setTimeout(() => {
                    // [å…³é”®ä¿®å¤] ä¸ä¿å­˜æ—¶ä¸ä¼  keyï¼Œé¿å…å†å²è®°å½•ä¸å­˜åœ¨çš„ key
                    if (autoSave) {
                        window.location.href = `/read?url=${encodeURIComponent(firstChapterUrl)}&key=${encodeURIComponent(key)}`;
                    } else {
                        // ä¸ä¿å­˜æ—¶ï¼Œåªä¼  URLï¼Œä¸ä¼  key
                        window.location.href = `/read?url=${encodeURIComponent(firstChapterUrl)}`;
                    }
                }, 300);
                
            } catch(e) {
                console.error('è·å–ç›®å½•å¤±è´¥:', e);
                // å¤±è´¥åˆ™ç›´æ¥è·³è½¬åŸURL
                PureUI.loading.hide();
                if (autoSave) {
                    PureUI.toast('å·²ä¿å­˜ï¼Œæ­£åœ¨è·³è½¬...', 'info');
                }
                setTimeout(() => {
                    if (autoSave) {
                        window.location.href = `/read?url=${encodeURIComponent(url)}&key=${encodeURIComponent(key)}`;
                    } else {
                        window.location.href = `/read?url=${encodeURIComponent(url)}`;
                    }
                }, 300);
            }
        }

        async function pollSearchTask(taskId) {
            let attempts = 0;
            const maxAttempts = 60; 
            
            const poll = async () => {
                if (attempts >= maxAttempts) {
                    PureUI.loading.close();
                    document.getElementById('resultsContainer').innerHTML = '<div class="empty-state"><p>æœç´¢è¶…æ—¶</p></div>';
                    return;
                }
                
                try {
                    const res = await fetch(`${API_URL}/api/task_status/${taskId}`);
                    const t = await res.json();
                    
                    if (t.status === 'completed') {
                        PureUI.loading.hide();
                        try {
                            handleSearchResults(t.result); // Should be full result by now
                        } catch (err) {
                            console.error("Render error:", err);
                             document.getElementById('resultsContainer').innerHTML = `<div class="empty-state"><p>æ¸²æŸ“ç»“æœå‡ºé”™: ${escapeHtml(err.message)}</p></div>`;
                        }
                        return;
                    } else if (t.status === 'failed') {
                        PureUI.loading.hide();
                        document.getElementById('resultsContainer').innerHTML = `<div class="empty-state"><p>æœç´¢å‡ºé”™: ${escapeHtml(t.error)}</p></div>`;
                        return;
                    } else if (t.status === 'not_found') {
                        PureUI.loading.hide();
                         document.getElementById('resultsContainer').innerHTML = '<div class="empty-state"><p>ä»»åŠ¡å·²å¤±æ•ˆï¼Œè¯·é‡è¯•</p></div>';
                        return;
                    } else {
                        // [New] Update Progress UI
                        if (t.message) PureUI.loading.show(t.message);
                        // [New] Render intermediate results if available
                        if (t.result && t.result.length > 0) {
                            handleSearchResults(t.result);
                        }
                        
                        attempts++;
                        setTimeout(poll, 1000);
                    }
                } catch(e) {
                    // [Debug] Log exact error that causes retry
                    console.error("Poll error (will retry):", e);
                    attempts++;
                    setTimeout(poll, 1000);
                }
            };
            poll();
        }

        function handleSearchResults(data) {
             console.log("Handling Search Results:", data);
             if (!data) data = []; // Safety check
             
             const container = document.getElementById('resultsContainer');
             const statsBar = document.getElementById('statsBar');
             
             if (data && data.length > 0) {
                 currentResults = data;
                 renderResults(currentResults);
                 statsBar.style.display = 'flex';
                 document.getElementById('resultCount').innerText = currentResults.length;
             } else {
                 statsBar.style.display = 'none'; // Hide stats if no results
                 container.innerHTML = `
                        <div class="empty-state">
                            <p style="font-size:16px; color:#6b7280; margin-bottom:10px;">ğŸ˜¢ æœªæ‰¾åˆ°ç›¸å…³ç»“æœ</p>
                            <p style="font-size:13px; color:#9ca3af;">å°è¯•ï¼š</p>
                            <ul style="text-align:left; display:inline-block; color:#9ca3af; font-size:13px; margin-top:8px;">
                                <li>ç®€åŒ–å…³é”®è¯ï¼ˆå¦‚ï¼š"å‡¡äººä¿®ä»™ä¼ " â†’ "å‡¡äºº"ï¼‰</li>
                                <li>æœç´¢ä½œè€…å</li>
                                <li>æ£€æŸ¥æ‹¼å†™æ˜¯å¦æ­£ç¡®</li>
                            </ul>
                        </div>
                 `;
             }
        }
    </script>
    
    <style>
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</body>
</html>
