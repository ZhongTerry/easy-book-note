<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- åœ¨ <head> ä¸­æ·»åŠ  -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <title>{{ article.title }} - Smart NoteDB</title>
    <style>
        :root {
            --bg-outer: #e0e0e0;      
            --bg-reader: #f2f2f2;     
            --bg-header: rgba(255, 255, 255, 0.9);
            --text-main: #262626;     
            --text-meta: #999999;     
            --accent: #4f46e5;
            --border-color: rgba(0, 0, 0, 0.05);
            --font-main: "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", sans-serif;
        }

/* === æ ¸å¿ƒï¼šæ·±åº¦å¤åˆ»ç•ªèŒ„é»‘æš—æ¨¡å¼é…è‰² === */
        body.dark-mode {
            --bg-outer: #141414;      /* ææ·±ç°èƒŒæ™¯ */
            --bg-reader: #1e1e1e;     /* ç¨æµ…çš„å®¹å™¨èƒŒæ™¯ */
            --bg-header: rgba(26, 26, 26, 0.9); /* é¡¶æ éšä¹‹å˜è‰² */
            --text-main: #cecece;     /* æµ…ç°æ–‡å­—ï¼Œä¸åˆºçœ¼ */
            --text-meta: #666666;     /* æš—ç°è¾…åŠ©æ–‡å­— */
            --border-color: #2d2d2d;  /* é»‘æš—æ¨¡å¼ä¸‹çš„åˆ†å‰²çº¿ */
        }

        body {
            background-color: var(--bg-outer);
            margin: 0; padding: 0;
            font-family: var(--font-main);
            transition: background 0.3s, color 0.3s;
            display: flex; flex-direction: column; align-items: center;
        }

        /* é¡¶æ é€‚é…å˜é‡ */
        header {
            width: 100%; height: 60px;
            background: var(--bg-header); /* ä½¿ç”¨å˜é‡ */
            backdrop-filter: blur(10px);
            position: fixed; top: 0; z-index: 100;
            display: flex; justify-content: center;
            border-bottom: 1px solid var(--border-color); /* ä½¿ç”¨å˜é‡ */
            transition: background 0.3s;
        }



        /* === Header === */
        .header-content {
            width: 90%; max-width: 1200px;
            display: flex; justify-content: space-between; align-items: center;
        }
        .header-left { display: flex; align-items: center; cursor: pointer; color: #333; }
        .header-left span { font-size: 16px; font-weight: 500; margin-left: 10px; }

        .header-right { display: flex; align-items: center; gap: 15px; }
        .btn-refresh-page { 
            background: #ff4d4f; color: white; border: none; padding: 6px 12px; 
            border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: bold; 
        }
        .user-avatar { width: 32px; height: 32px; border-radius: 50%; background: #ddd; object-fit: cover; }

        /* === Main Content === */
        .main-container {
            width: 100%; max-width: 900px;
            background: var(--bg-reader);
            margin-top: 80px; margin-bottom: 40px;
            padding: 80px 100px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.03);
            box-sizing: border-box; min-height: 100vh; position: relative;
        }
        .article-header { margin-bottom: 50px; }
        .article-header h1 { font-size: 32px; font-weight: 700; color: #1a1a1a; margin: 0 0 15px 0; }
        .article-meta { font-size: 13px; color: var(--text-meta); display: flex; gap: 20px; }

        .content-body { font-size: 19px; line-height: 1.9; color: var(--text-main); text-align: justify; }
        .content-body p { margin-bottom: 28px; }

        /* === Floating Menu === */
        .floating-menu {
            position: fixed; right: calc(50% - 530px);
            top: 250px; display: flex; flex-direction: column; gap: 12px; z-index: 90;
        }
        .menu-item {
            width: 50px; height: 64px; background: #fff; border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            cursor: pointer; transition: 0.2s; border: 1px solid transparent; color: #666;
        }
        .menu-item:hover { border-color: var(--accent); color: var(--accent); }
        .menu-item svg { width: 20px; height: 20px; margin-bottom: 4px; }
        .menu-item span { font-size: 11px; }

        /* [æ–°å¢] éª¨æ¶å±æ ·å¼å¢å¼º === */
        .skeleton-loader { 
            display: none; 
            padding: 80px 100px; 
            animation: fadein 0.3s; 
        }

        .sk-header { 
            margin-bottom: 50px; 
        }

        .sk-title { 
            height: 48px; 
            width: 60%; 
            border-radius: 8px; 
            margin-bottom: 15px; 
        }

        .sk-meta-group { 
            display: flex; 
            gap: 20px; 
        }

        .sk-meta { 
            height: 16px; 
            border-radius: 4px; 
        }

        .sk-content { 
            margin-bottom: 100px; 
        }

        .sk-para { 
            height: 22px; 
            margin-bottom: 28px; 
            border-radius: 4px; 
        }

        .sk-line { 
            background: linear-gradient(90deg, #f0f0f0 25%, #e6e6e6 50%, #f0f0f0 75%); 
            background-size: 200% 100%; 
            animation: sk-loading 1.5s infinite; 
        }

        .sk-nav { 
            display: flex; 
            justify-content: center; 
            gap: 30px; 
            padding: 60px 0; 
            border-top: 1px solid var(--border-color); 
        }

        .sk-btn { 
            width: 220px; 
            height: 56px; 
            border-radius: 28px; 
        }
        
        body.dark-mode .sk-line { 
            background: linear-gradient(90deg, #2a2a2a 25%, #333333 50%, #2a2a2a 75%); 
        }

        @keyframes sk-loading { 
            0% { background-position: 200% 0; } 
            100% { background-position: -200% 0; } 
        }

        /* === é˜…è¯»è¿›åº¦æ¡ï¼ˆå›ºå®šåœ¨headerä¸‹æ–¹ï¼‰ === */
        #readingProgressBar {
            position: fixed;
            top: 60px; /* header é«˜åº¦ */
            left: 0;
            height: 2px;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            width: 0%;
            z-index: 98; /* ä½äº AJAX è¿›åº¦æ¡(999) å’Œ header(100) */
            transition: width 0.1s ease-out;
            opacity: 0.8;
            pointer-events: none; /* ä¸é˜»æŒ¡ç‚¹å‡» */
        }
        
        body.dark-mode #readingProgressBar {
            background: linear-gradient(90deg, #5c6bc0 0%, #7e57c2 100%);
            opacity: 0.9;
        }

        /* === Modals === */
        .modal-overlay {
            position: fixed; left: 0; top: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); display: none; z-index: 1000;
            align-items: center; justify-content: center;
        }
        .modal-box {
            background: #fff; width: 90%; max-width: 420px; border-radius: 12px;
            padding: 24px; box-shadow: 0 15px 40px rgba(0,0,0,0.2);
            max-height: 90vh; overflow-y: auto; position: relative;
            display: flex;
            flex-direction: column; /* ç¡®ä¿å†…éƒ¨å¸ƒå±€æ›´ç¨³å®š */
        }
        .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding-bottom: 12px; margin-bottom: 20px; }
        .modal-title { font-size: 18px; font-weight: bold; margin: 0; }

        /* è®¾ç½®å†…éƒ¨æ ·å¼ */
        .setting-row { margin-bottom: 25px; }
        .setting-label { display: block; font-size: 14px; color: #666; margin-bottom: 12px; font-weight: bold; }
        .slider-wrap { display: flex; align-items: center; gap: 15px; }
        .slider { flex: 1; cursor: pointer; accent-color: var(--accent); }
        .slider-val { font-size: 16px; font-weight: bold; color: var(--accent); min-width: 35px; text-align: center; }
        .btn-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .btn-action { 
            padding: 12px; border-radius: 8px; border: 1px solid #eee; background: #f8f9fa;
            cursor: pointer; font-size: 14px; display: flex; align-items: center; justify-content: center; gap: 6px;
        }
        .btn-action:hover { border-color: var(--accent); color: var(--accent); }

        /* === æ¢æºæ‰‹åŠ¨ä¹¦åè¾“å…¥ === */
        .source-title-row {
            display: flex;
            gap: 10px;
            align-items: center;
            margin: 10px 0 15px 0;
            padding: 10px;
            border: 1px solid #eef2f7;
            border-radius: 10px;
            background: #f8fafc;
        }
        .source-title-input {
            flex: 1;
            height: 34px;
            padding: 0 12px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            font-size: 12px;
            background: #fff;
        }
        .source-title-input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.12);
        }
        .source-search-btn {
            height: 34px;
            padding: 0 12px;
            border: 1px solid var(--accent);
            background: var(--accent);
            color: #fff;
            border-radius: 8px;
            font-size: 12px;
            cursor: pointer;
            white-space: nowrap;
            transition: 0.2s;
        }
        .source-search-btn:hover { filter: brightness(1.05); }

        body.dark-mode .source-title-row {
            background: #1f2937;
            border-color: #374151;
        }
        body.dark-mode .source-title-input {
            background: #111827;
            border-color: #374151;
            color: #e5e7eb;
        }

        /* ç›®å½•å†…ä¸“ç”¨åˆ·æ–°æŒ‰é’® */
        .btn-refresh-toc { background: #eef2ff; color: var(--accent); border: 1px solid var(--accent); padding: 4px 10px; border-radius: 4px; font-size: 12px; cursor: pointer; }
        .btn-refresh-toc:hover { background: var(--accent); color: white; }

        /* å…¶å®ƒ */
        .bottom-nav { margin-top: 80px; padding-top: 40px; border-top: 1px solid #eee; display: flex; justify-content: space-between; }
        .nav-btn { padding: 10px 35px; border-radius: 25px; border: 1px solid #ddd; color: #666; text-decoration: none; font-size: 15px; }
        .nav-btn:hover { background: #f9f9f9; border-color: var(--accent); color: var(--accent); }
        .nav-btn.disabled { opacity: 0.5; pointer-events: none; }
        #toast { visibility: hidden; background: #333; color: #fff; padding: 10px 20px; border-radius: 4px; position: fixed; left: 50%; bottom: 30px; transform: translateX(-50%); z-index: 3000; }
        #toast.show { visibility: visible; }
        .sync-alert { position: fixed; top: -60px; left: 0; width: 100%; background: var(--accent); color: white; padding: 12px; text-align: center; transition: 0.5s; z-index: 2000; }
        .sync-alert.active { top: 0; }
        .header-left, .user-box {
            color: var(--text-main); /* ç¡®ä¿é¡¶æ æ–‡å­—åœ¨é»‘æš—æ¨¡å¼ä¸‹å˜ç™½ */
        }
        @media (max-width: 1100px) { .floating-menu { right: 20px; } }
        /* å³ä¾§æ‚¬æµ®æŒ‰é’®é€‚é… */
.menu-item {
    background: var(--bg-reader);
    color: var(--text-main);
    border: 1px solid var(--border-color);
}

/* æ¨¡æ€æ¡†é€‚é… */
body.dark-mode .modal-box {
    background: #252525;
    color: var(--text-main);
    border: 1px solid #333;
}

body.dark-mode .modal-header {
    border-bottom-color: #333;
}

/* ç›®å½•é¡¹é€‚é… */
body.dark-mode .toc-item {
    border-bottom-color: #2d2d2d;
    color: #aaaaaa;
}

body.dark-mode .toc-item:hover {
    background: #2a2a2a;
}

/* ç›®å½•å½“å‰ç« èŠ‚é«˜äº®é€‚é… */
body.dark-mode .toc-item.active-chap {
    background-color: #1a2736 !important; /* æ·±è“è‰²é«˜äº® */
    color: var(--accent) !important;
}

/* è®¾ç½®é¢æ¿å†…çš„æŒ‰é’®é€‚é… */
body.dark-mode .btn-action {
    background: #2a2a2a;
    border-color: #333;
    color: #ccc;
}
        /* --- ä¿®æ”¹ 1: å¢åŠ  Modal é«˜åº¦ --- */
        .modal-box {
            background: #fff; 
            width: 90%; 
            max-width: 420px; 
            border-radius: 12px;
            padding: 24px; 
            box-shadow: 0 15px 40px rgba(0,0,0,0.2);
            /* ä» 85vh æé«˜åˆ° 90vhï¼Œåˆ©ç”¨æœ€å¤§ç©ºé—´ */
            max-height: 90vh; 
            overflow-y: auto; 
            position: relative;
            display: flex;
            flex-direction: column; /* ç¡®ä¿å†…éƒ¨å¸ƒå±€æ›´ç¨³å®š */
        }

        /* --- ä¿®æ”¹ 2: å¢åŠ ç›®å½•æ¡ç›®é«˜åº¦å’Œäº¤äº’æ„Ÿ --- */
        .toc-item { 
            display: block; 
            /* å¢åŠ ä¸Šä¸‹å†…è¾¹è·ï¼Œä» 10px æé«˜åˆ° 14px */
            padding: 14px 12px; 
            border-bottom: 1px solid #f5f5f5; 
            color: #444; 
            text-decoration: none; 
            font-size: 14px; 
            transition: all 0.2s;
            border-radius: 6px; /* å¢åŠ ä¸€ç‚¹åœ†è§’æ„Ÿ */
        }

        /* --- ä¿®æ”¹ 3: æ–°å¢å½“å‰ç« èŠ‚é«˜äº®æ ·å¼ --- */
        .toc-item.active-chap {
            color: var(--accent) !important;
            background-color: #f0f4ff; /* æ·¡æ·¡çš„è“ç´«è‰²èƒŒæ™¯ */
            font-weight: bold;
        }
        /* === ä¼˜åŒ–åçš„å¼ºåˆ¶åˆ·æ–°æŒ‰é’®ï¼šæç®€è¾¹æ¡†é£æ ¼ === */
.btn-refresh-page { 
    background: transparent;           /* é€æ˜èƒŒæ™¯ */
    color: var(--text-meta);           /* å¹³æ—¶ä½¿ç”¨æš—è‰²è¾…åŠ©æ–‡å­— */
    border: 1px solid var(--border-color); /* ä½¿ç”¨å˜é‡å®šä¹‰çš„è¾¹æ¡†è‰² */
    padding: 5px 12px; 
    border-radius: 6px; 
    cursor: pointer; 
    font-size: 12px; 
    font-weight: 500; 
    transition: all 0.2s ease;         /* å¢åŠ å¹³æ»‘è¿‡æ¸¡ */
    display: flex;
    align-items: center;
    gap: 4px;
}

/* é¼ æ ‡æ‚¬æµ®æ—¶æ‰äº®èµ·ä¸»é¢˜è‰² */
.btn-refresh-page:hover { 
    color: var(--accent); 
    border-color: var(--accent);
    background: rgba(79, 70, 229, 0.05); /* æ·¡æ·¡çš„ç´«è‰²èƒŒæ™¯ï¼Œå¢åŠ äº¤äº’æ„Ÿ */
}

/* é»‘æš—æ¨¡å¼ä¸‹çš„å¾®è°ƒï¼šé™ä½å­˜åœ¨æ„Ÿ */
body.dark-mode .btn-refresh-page {
    border-color: #333;
    color: #888;
}

body.dark-mode .btn-refresh-page:hover {
    color: var(--accent);
    border-color: var(--accent);
    background: rgba(79, 70, 229, 0.1);
}
.header-right { 
    display: flex; 
    align-items: center; 
    gap: 20px; /* å¢åŠ ä¸€ç‚¹æŒ‰é’®ä¸å¤´åƒçš„é—´è· */
}

.user-box { 
    display: flex; 
    align-items: center; 
    gap: 8px; 
    font-size: 14px; 
    color: var(--text-main); 
    padding-left: 20px;
    border-left: 1px solid var(--border-color); /* åœ¨åˆ·æ–°æŒ‰é’®å’Œç”¨æˆ·ä¹‹é—´åŠ ä¸€æ¡å¾ˆæµ…çš„ç«–çº¿ */
}
/* === æ·±åº¦å¤åˆ»ï¼šç•ªèŒ„ç¿»é¡µæŒ‰é’®æ ·å¼ === */
.bottom-nav {
    margin-top: 100px; 
    padding: 60px 0; 
    border-top: 1px solid var(--border-color); 
    display: flex; 
    justify-content: center; /* æŒ‰é’®å±…ä¸­ */
    gap: 30px;               /* æŒ‰é’®é—´è· */
}

.nav-btn {
    width: 220px;            /* å›ºå®šå®½åº¦ */
    height: 56px;            /* å›ºå®šé«˜åº¦ */
    border-radius: 28px;     /* é«˜åº¦çš„ä¸€åŠï¼Œå½¢æˆå®Œç¾çš„åŠåœ†è§’ */
    display: flex;
    align-items: center;
    justify-content: center;
    text-decoration: none;
    font-size: 16px;
    font-weight: 500;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    border: none;            /* å»æ‰è¾¹æ¡† */
    cursor: pointer;
}

/* ä¸Šä¸€ç« ï¼šæµ…ç°è‰²é£æ ¼ */
.nav-btn.prev-style {
    background-color: #e5e5e5; /* æˆªå›¾ä¸­çš„æµ…ç° */
    color: #333;
}
.nav-btn.prev-style:hover {
    background-color: #d8d8d8;
    transform: translateY(-2px);
}

/* ä¸‹ä¸€ç« ï¼šç•ªèŒ„é†’ç›®æ©™è‰² */
.nav-btn.next-style {
    background-color: #ff6633; /* ç•ªèŒ„æ ‡å¿—æ€§æ©™è‰² */
    color: #ffffff;
    box-shadow: 0 4px 15px rgba(255, 102, 51, 0.3); /* æ©™è‰²å‘å…‰é˜´å½± */
}
.nav-btn.next-style:hover {
    background-color: #ff7744;
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(255, 102, 51, 0.4);
}

/* === é»‘æš—æ¨¡å¼ä¸‹çš„æŒ‰é’®é€‚é… === */
body.dark-mode .nav-btn.prev-style {
    background-color: #333333; /* æ·±ç°èƒŒæ™¯ */
    color: #aaaaaa;            /* æµ…ç°æ–‡å­— */
}

body.dark-mode .nav-btn.next-style {
    background-color: #cc5229; /* ç¨å¾®è°ƒæš—ä¸€ç‚¹çš„æ©™è‰²ï¼Œä¸åˆºçœ¼ */
    color: #ffffff;
}

/* ç¦ç”¨çŠ¶æ€ */
.nav-btn.disabled {
    opacity: 0.3;
    pointer-events: none;
    background-color: #ccc !important;
}
/* === ç²¾ç®€ç‰ˆï¼šç•ªèŒ„åŒæ¬¾ç»Ÿä¸€ç°è‰²æŒ‰é’® === */
.bottom-nav {
    margin-top: 60px;          /* ç¼©å°é¡¶éƒ¨é—´è· */
    padding: 40px 0; 
    border-top: 1px solid var(--border-color); 
    display: flex; 
    justify-content: center; 
    gap: 20px;                 /* ç¼©å°æŒ‰é’®é—´è· */
}

.nav-btn {
    width: 130px;             
    height: 30px;             
    border-radius: 20px;       /* å®Œç¾çš„åŠåœ†è§’ */
    display: flex;
    align-items: center;
    justify-content: center;
    text-decoration: none;
    font-size: 14px;           /* å­—ä½“ä¹Ÿç¨å¾®ç¼©å°ä¸€ç‚¹ï¼Œæ›´ç²¾è‡´ */
    font-weight: 500;
    transition: all 0.2s ease;
    border: none;
    cursor: pointer;
    
    /* ç»Ÿä¸€é…è‰²ï¼šä¸Šä¸€ç« çš„ç»å…¸æµ…ç°è‰² */
    background-color: #e5e5e5; 
    color: #333;
}

.nav-btn:hover {
    background-color: #d8d8d8;
    transform: translateY(-1px); /* è½»å¾®ä¸Šæµ®ï¼ŒPCç«¯æ‰‹æ„Ÿæ›´å¥½ */
}

/* === é»‘æš—æ¨¡å¼é€‚é… === */
body.dark-mode .nav-btn {
    background-color: #333333; /* æ·±ç°èƒŒæ™¯ */
    color: #aaaaaa;            /* æµ…ç°æ–‡å­— */
}

body.dark-mode .nav-btn:hover {
    background-color: #444444;
    color: #cecece;
}

/* ç¦ç”¨çŠ¶æ€ */
.nav-btn.disabled {
    opacity: 0.3;
    pointer-events: none;
}
/* ... åŸæœ‰æ ·å¼ä¿æŒä¸å˜ ... */

/* === æ–°å¢ï¼šé¢œè‰²è®¾ç½®åŒºåŸŸæ ·å¼ === */
.color-setting-grid {
    display: grid;
    grid-template-columns: 1fr 1fr auto;
    gap: 10px;
    align-items: center;
}

.color-input-wrapper {
    display: flex;
    flex-direction: column;
    gap: 5px;
    font-size: 12px;
    color: #666;
}

/* ç¾åŒ–é¢œè‰²é€‰æ‹©å™¨ input */
input[type="color"] {
    -webkit-appearance: none;
    border: 1px solid #ddd;
    border-radius: 6px;
    width: 100%;
    height: 36px;
    padding: 2px;
    background: white;
    cursor: pointer;
}
input[type="color"]::-webkit-color-swatch-wrapper { padding: 0; }
input[type="color"]::-webkit-color-swatch { border: none; border-radius: 4px; }

/* é‡ç½®æŒ‰é’® */
.btn-reset-color {
    padding: 0 15px;
    height: 36px;
    margin-top: 18px; /* å¯¹é½ input */
    border: 1px solid #eee;
    background: #fff;
    color: #666;
    border-radius: 6px;
    cursor: pointer;
    font-size: 13px;
    transition: 0.2s;
}
.btn-reset-color:hover {
    border-color: #ff4d4f;
    color: #ff4d4f;
}
/* === åˆ†äº«æ¨¡æ€æ¡†æ ·å¼ === */
.share-body {
    display: flex;
    flex-direction: column;
    gap: 15px;
}

.share-text-area textarea {
    width: 100%;
    height: 100px;
    border: 1px solid #eee;
    border-radius: 8px;
    padding: 10px;
    font-size: 13px;
    resize: none;
    background: #f9f9f9;
    color: #555;
    box-sizing: border-box; /* é˜²æ­¢æ’‘ç ´å®¹å™¨ */
    font-family: sans-serif;
}

.btn-copy {
    width: 100%;
    padding: 10px;
    margin-top: 8px;
    background: var(--accent);
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-weight: bold;
    transition: 0.2s;
}
.btn-copy:hover { opacity: 0.9; }

.share-divider {
    text-align: center;
    position: relative;
    color: #ccc;
    font-size: 12px;
    margin: 5px 0;
}
.share-divider::before, .share-divider::after {
    content: "";
    position: absolute;
    top: 50%;
    width: 40%;
    height: 1px;
    background: #eee;
}
.share-divider::before { left: 0; }
.share-divider::after { right: 0; }

.qr-section {
    display: flex;
    flex-direction: column;
    align-items: center;
    background: white;
    padding: 10px;
    border-radius: 8px;
}

#qrcode img {
    margin: 0 auto;
    display: block;
    padding: 5px;
    background: white; /* ç¡®ä¿äºŒç»´ç åœ¨é»‘æš—æ¨¡å¼ä¸‹ä¹Ÿæœ‰ç™½åº•ï¼Œå¦åˆ™æ‰«ä¸å‡ºæ¥ */
    border-radius: 4px;
}

.qr-tip {
    margin-top: 8px;
    font-size: 12px;
    color: #999;
}

/* é»‘æš—æ¨¡å¼é€‚é… */
body.dark-mode .share-text-area textarea {
    background: #2a2a2a;
    border-color: #444;
    color: #ccc;
}
/* === 1. ä¿®å¤æ ‡é¢˜é¢œè‰² (æ”¯æŒå¤œé—´æ¨¡å¼) === */
.article-header h1 { 
    font-size: 32px; 
    font-weight: 700; 
    /* [æ ¸å¿ƒä¿®æ”¹] åˆ«å†™æ­»é¢œè‰²ï¼Œä½¿ç”¨å˜é‡ */
    color: var(--text-main); 
    margin: 0 0 15px 0; 
}

/* === 2. åˆ†äº«æ¡† Textarea ç¾åŒ– === */
.share-text-area textarea {
    width: 100%;
    height: 110px;
    padding: 12px;
    font-size: 14px;
    line-height: 1.6;
    border-radius: 12px; /* æ›´åœ†æ¶¦ */
    border: 1px solid #e5e7eb;
    background: #f9fafb; /* æµ…ç°èƒŒæ™¯ */
    color: #374151;
    resize: none; /* ç¦æ­¢æ‹–åŠ¨å¤§å° */
    outline: none;
    font-family: inherit;
    transition: all 0.2s;
    box-sizing: border-box;
}

/* èšç„¦æ—¶çš„é«˜äº®æ•ˆæœ */
.share-text-area textarea:focus {
    background: #fff;
    border-color: var(--accent);
    box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
}

/* é»‘æš—æ¨¡å¼é€‚é… */
body.dark-mode .share-text-area textarea {
    background: #1f2937;
    border-color: #374151;
    color: #e5e7eb;
}

body.dark-mode .share-text-area textarea:focus {
    background: #111827;
    border-color: var(--accent);
}

/* === 3. Modal é®ç½©å±‚ä¼˜åŒ–ï¼ˆé…åˆ JS ä¿®å¤è¯¯è§¦ï¼‰ === */
/* ç¡®ä¿é®ç½©å±‚è¦†ç›–å…¨å±ä¸”å±‚çº§æ­£ç¡® */
.modal-overlay {
    /* åŸæœ‰æ ·å¼ä¿æŒä¸å˜... */
    cursor: default; /* é¿å…é¼ æ ‡åœ¨é®ç½©å±‚ä¸Šæ˜¾ç¤ºä¸ºæ‰‹å‹ï¼Œæš—ç¤ºç‚¹å‡»å…³é—­ */
}
/* ä¼˜åŒ–ä¸‹æ‹‰æ¡†å’Œè¾“å…¥æ¡†ï¼Œä½¿å…¶åœ¨è®¾ç½®é¢æ¿ä¸­æ›´åè°ƒ */
#settingsModal select.p-input, 
#settingsModal input.p-input {
    height: 36px;
    padding: 0 10px;
    border: 1px solid #ddd;
    border-radius: 6px;
    background: #f9f9f9;
    font-size: 13px;
    outline: none;
    transition: all 0.2s;
}

#settingsModal select.p-input:focus,
#settingsModal input.p-input:focus {
    background: #fff;
    border-color: var(--accent);
    box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.1);
}

/* é»‘æš—æ¨¡å¼é€‚é… */
body.dark-mode #settingsModal select.p-input,
body.dark-mode #settingsModal input.p-input {
    background: #2a2a2a;
    border-color: #444;
    color: #ccc;
}
    </style>
    <script>
        // === [æ ¸å¿ƒä¿®å¤] æ™ºèƒ½å…³é—­ Modal ===
    // åªæœ‰å½“ç‚¹å‡»äº‹ä»¶çœŸæ­£å‘ç”Ÿåœ¨é®ç½©å±‚æœ¬èº«(overlay)æ—¶æ‰å…³é—­
    // è§£å†³äº†â€œåœ¨å†…éƒ¨é€‰ä¸­æ–‡å­—æ‹–æ‹½åˆ°å¤–éƒ¨æ¾å¼€å¯¼è‡´å…³é—­â€çš„ Bug
    function closeByOverlay(event, modalId) {
        if (event.target === event.currentTarget) {
            document.getElementById(modalId).style.display = 'none';
        }
    }
    </script>
</head>
<body>

    <div id="syncAlert" class="sync-alert">
        <span>ğŸ“¢ å…¶å®ƒè®¾å¤‡æ›´æ–°äº†è¿›åº¦</span>
        <!-- [æ ¸å¿ƒä¿®å¤] æ”¹å› a æ ‡ç­¾ï¼Œå¹¶åŠ ä¸Š id="syncLink" -->
        <a id="syncLink" href="#" style="background:white; color:var(--accent); text-decoration:none; padding:4px 12px; border-radius:12px; cursor:pointer; margin-left:10px; font-weight:bold; font-size:13px;">
            è·³è½¬æœ€æ–°
        </a>
        <button onclick="closeSyncAlert()" style="background:none; border:none; color:white; margin-left:10px; cursor:pointer; font-size:16px;">Ã—</button>
    </div>

<header>
    <div class="header-content">
        <div class="header-left" onclick="location.href='/'">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 18l-6-6 6-6"/></svg>
            <span>{{ db_key }}</span>
        </div>
        <div class="header-right">
            <button class="btn-refresh-page" onclick="forceRefresh()">ğŸ”„ å¼ºåˆ¶åˆ·æ–°é¡µé¢</button>
            <div style="display: flex; align-items: center; gap: 8px; font-size: 14px; color: #666;">
                <span id="userName">User</span>
                <img class="user-avatar" id="userAvatar" src="/static/icon-192.png">
            </div>
        </div>
    </div>
</header>

<!-- AJAX åŠ è½½è¿›åº¦æ¡ -->
<div id="ajaxProgressBar" style="position:fixed; top:0; left:0; height:3px; background:var(--accent); width:0; transition:width 0.3s; z-index:999;"></div>

<!-- é˜…è¯»è¿›åº¦æ¡ -->
<div id="readingProgressBar"></div>

<div class="main-container">
    <!-- [æ–°å¢] éª¨æ¶å±å®¹å™¨ -->
    <div id="skeletonBox" class="skeleton-loader">
        <!-- æ ‡é¢˜éª¨æ¶ -->
        <div class="sk-header">
            <div class="sk-line sk-title"></div>
            <div class="sk-meta-group">
                <div class="sk-line sk-meta" style="width:120px"></div>
                <div class="sk-line sk-meta" style="width:100px"></div>
            </div>
        </div>
        
        <!-- æ­£æ–‡éª¨æ¶(æ¨¡æ‹Ÿæ®µè½) -->
        <div class="sk-content">
            <div class="sk-line sk-para" style="width:100%"></div>
            <div class="sk-line sk-para" style="width:98%"></div>
            <div class="sk-line sk-para" style="width:95%"></div>
            <div class="sk-line sk-para" style="width:100%"></div>
            <div class="sk-line sk-para" style="width:92%"></div>
            <div class="sk-line sk-para" style="width:97%"></div>
            <div class="sk-line sk-para" style="width:100%"></div>
            <div class="sk-line sk-para" style="width:88%"></div>
        </div>
        
        <!-- å¯¼èˆªæ éª¨æ¶ -->
        <div class="sk-nav">
            <div class="sk-line sk-btn"></div>
            <div class="sk-line sk-btn"></div>
        </div>
    </div>

    <div class="article-header">
        <h1 id="chapterTitle">{{ article.title }}</h1>
        <div class="article-meta">
            <span>æœ¬ç« å­—æ•°: {{ article.content|join('')|length }}å­—</span>
            <span>æ¥æº: {{ db_key }}</span>
        </div>
    </div>

    <div class="content-body" id="articleBody">
        {% for line in article.content %}
            <p>{{ line }}</p>
        {% endfor %}
    </div>

    <div class="bottom-nav">
        {% if article.prev %}
        <a id="link-prev" href="/read?url={{ article.prev }}&key={{ db_key }}" class="nav-btn">ä¸Šä¸€ç« </a>
        {% else %}<span class="nav-btn disabled">å·²æ˜¯å¼€å¤´</span>{% endif %}

        {% if article.next %}
        <a id="link-next" href="/read?url={{ article.next }}&key={{ db_key }}" class="nav-btn">ä¸‹ä¸€ç« </a>
        {% else %}
        <span class="nav-btn disabled" onclick="handleNoNextChapter()" style="cursor:pointer;" title="ç‚¹å‡»é‡æ–°æ£€æŸ¥æ›´æ–°">
            å·²æ˜¯æœ«å°¾ ğŸ”„
        </span>
        {% endif %}
    </div>
</div>

<aside class="floating-menu">
    <div class="menu-item" onclick="location.href='/'">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/></svg>
        <span>ä¹¦æ¶</span>
    </div>
    <div class="menu-item" id="saveToShelfBtn" onclick="saveToShelf()" title="å°†å½“å‰ä¹¦ç±ä¿å­˜åˆ°ä¹¦æ¶">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"/>
        </svg>
        <span>æ”¶è—</span>
    </div>
    <div class="menu-item" onclick="showModal('tocOverlay')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 6h16M4 12h16M4 18h16"/></svg>
        <span>ç›®å½•</span>
    </div>
    <div class="menu-item" onclick="toggleDarkMode()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>
        <span>å¤œé—´</span>
    </div>
    <div class="menu-item" onclick="showModal('settingsModal')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
        <span>è®¾ç½®</span>
    </div>
</aside>
<div id="tocOverlay" class="modal-overlay" onclick="closeByOverlay(event, 'tocOverlay')">
    <div class="modal-box" onclick="event.stopPropagation()">
        <div class="modal-header">
            <h3 class="modal-title">ç›®å½•</h3>
            <div style="display: flex; gap: 10px; align-items: center;">
                 <!-- ç›®å½•å†…åˆ·æ–°æŒ‰é’® -->
                 <button class="btn-refresh-toc" onclick="loadTOC(true)" title="ä»æºç«™é‡æ–°æŠ“å–ç›®å½•">ğŸ”„ åˆ·æ–°</button>
                 <!-- å…³é—­æŒ‰é’® -->
                 <button onclick="document.getElementById('tocOverlay').style.display='none'" style="border:none; background:none; font-size:20px; cursor:pointer;">Ã—</button>
            </div>
        </div>
        <!-- ç›®å½•åˆ—è¡¨å®¹å™¨ -->
        <div id="tocList" style="flex: 1; overflow-y: auto;">
            <!-- ç›®å½•å°†é€šè¿‡ JS åŠ¨æ€åŠ è½½åˆ°è¿™é‡Œ -->
        </div>
    </div>
</div>
<!-- è®¾ç½® Modal -->
<div id="settingsModal" class="modal-overlay" onclick="closeByOverlay(event, 'settingsModal')">
    <div class="modal-box" onclick="event.stopPropagation()">
        <div class="modal-header">
            <h3 class="modal-title">é˜…è¯»è®¾ç½®</h3>
            <button onclick="document.getElementById('settingsModal').style.display='none'" style="border:none; background:none; font-size:20px; cursor:pointer;">Ã—</button>
        </div>
        
        <div class="setting-row">
            <span class="setting-label">æ­£æ–‡å­—å·</span>
            <div class="slider-wrap">
                <input type="range" id="fontSlider" class="slider" min="15" max="35" value="19" oninput="updateFS(this.value)">
                <span id="fontVal" class="slider-val">19</span>
            </div>
        </div>
        <div class="setting-row">
            <span class="setting-label">å­—ä½“é€‰æ‹©</span>
            <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                <!-- å­—ä½“ä¸‹æ‹‰æ¡† -->
                <select id="fontSelector" class="p-input" onchange="changeFontFamily(this.value)" style="flex: 1;">
                    <optgroup label="é»˜è®¤é¢„è®¾">
                        <option value='-apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif'>ç³»ç»Ÿé»˜è®¤</option>
                        <option value='"PingFang SC", "Microsoft YaHei", sans-serif'>å¾®è½¯é›…é»‘</option>
                        <option value='"Songti SC", "Noto Serif SC", "SimSun", serif'>å®‹ä½“/æ˜ä½“</option>
                        <option value='"KaiTi", "KaiTi_GB2312", serif'>æ¥·ä½“</option>
                    </optgroup>
                    <!-- æœ¬åœ°æ‰«æåˆ°çš„å­—ä½“ä¼šè¿½åŠ åˆ°è¿™é‡Œ -->
                </select>
                
                <!-- æ–¹æ¡ˆBæŒ‰é’® -->
                <button class="btn-action" onclick="detectLocalFonts()" title="æ‰«ææœ¬åœ°å®‰è£…çš„å­—ä½“" style="width: auto; padding: 0 10px;">
                    ğŸ” æ‰«æ
                </button>
            </div>

            <!-- æ–¹æ¡ˆCï¼šç½‘ç»œå­—ä½“ -->
            <div style="display: flex; gap: 10px; align-items: center;">
                <input type="text" id="webFontUrl" class="p-input" placeholder="ç²˜è´´å­—ä½“æ–‡ä»¶(.woff2/.ttf) æˆ– CSS é“¾æ¥" style="font-size: 12px;">
                <button class="btn-action" onclick="loadCustomWebFont()" style="width: auto; padding: 0 15px; white-space: nowrap;">
                    â˜ï¸ åŠ è½½
                </button>
            </div>
            <div style="font-size: 11px; color: #999; margin-top: 4px;">
                æç¤ºï¼šæ”¯æŒ <a href="https://github.com/lxgw/LxgwWenKai" target="_blank" style="color:#666;text-decoration:underline;">éœé¹œæ–‡æ¥·</a> ç­‰å¼€æºå­—ä½“ç›´é“¾
            </div>
        </div>
        <div class="setting-row">
            <span class="setting-label">è‡ªå®šä¹‰èƒŒæ™¯</span>
            <div class="color-setting-grid">
                <div class="color-input-wrapper">
                    <label>å¤–éƒ¨èƒŒæ™¯</label>
                    <input type="color" id="bgOuterPicker" value="#e0e0e0" oninput="updateCustomColor('outer', this.value)">
                </div>
                <div class="color-input-wrapper">
                    <label>é˜…è¯»åŒºèƒŒæ™¯</label>
                    <input type="color" id="bgReaderPicker" value="#f2f2f2" oninput="updateCustomColor('reader', this.value)">
                </div>
                <button class="btn-reset-color" onclick="resetCustomColors()" title="æ¢å¤é»˜è®¤ä¸»é¢˜">é‡ç½®</button>
            </div>
        </div>
        <div class="setting-row">
            <span class="setting-label">å¿«æ·åŠŸèƒ½</span>
            <div class="btn-grid">
                <button class="btn-action" onclick="triggerSourceModal()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 3l4 4-4 4M8 21l-4-4 4-4M20 7H4M4 17h16"/></svg>
                    å…¨ç½‘æ¢æº
                </button>
                <button class="btn-action" id="ttsBtn" onclick="toggleTTS()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 5L6 9H2v6h4l5 4V5zM19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"/></svg>
                    å¼€å§‹æœ—è¯»
                </button>
                <!-- [æ–°å¢] åˆ†äº«æŒ‰é’® -->
                <button class="btn-action" onclick="nativeShare()" style="grid-column: span 2; justify-content: center; background-color: var(--accent); color: white; border:none;">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"/><polyline points="16 6 12 2 8 6"/><line x1="12" y1="2" x2="12" y2="15"/></svg>
                    åˆ†äº«æœ¬ä¹¦
                </button>
            </div>
        </div>
        <div class="setting-row">
            <span class="setting-label">é«˜çº§é€‰é¡¹</span>
            <div class="btn-grid">
                <button class="btn-action" onclick="forceRefresh()">
                    <span>ğŸ”„</span> å¼ºåˆ¶é‡æ–°æŠ“å–
                </button>
                <button class="btn-action" onclick="triggerSourceModal()">
                    <span>ğŸ“š</span> åˆ‡æ¢ä¹¦æº...
                </button>
            </div>
        </div>

        <!-- [æ–°å¢] è¿½æ›´å¼€å…³ (æ”¾åœ¨è®¾ç½®é¢æ¿çš„é«˜çº§é€‰é¡¹é‡Œ) -->
        <div class="setting-row">
            <span class="setting-label">è‡ªåŠ¨è¿½æ›´ç³»ç»Ÿ</span>
            <div class="btn-grid">
                <button class="btn-action" id="pcSubBtn" onclick="toggleSubscribePC()">
                    <span>ğŸ””</span> å¼€å¯è¿½æ›´
                </button>
            </div>
            <div style="font-size:12px; color:#999; margin-top:5px; text-align:center;">
                ç³»ç»Ÿå°†æ¯éš” 5 å°æ—¶è‡ªåŠ¨æ£€æŸ¥ä¸€æ¬¡æ›´æ–°
            </div>
        </div>

        <!-- [æ–°å¢] è°ƒè¯•é“¾æ¥ -->
        <div class="setting-row" style="margin-bottom:0;">
            <button class="btn-action" onclick="window.open('{{ current_url }}', '_blank')" style="width:100%; justify-content:center; color:#666;">
                ğŸ”— åœ¨æ–°æ ‡ç­¾é¡µæ‰“å¼€æºç½‘ç«™
            </button>
        </div>
        </div>
    </div>

    <!-- æ¢æºæ¨¡æ€æ¡† -->
    <div id="sourceModal" class="modal-overlay" onclick="if(event.target===this) this.style.display='none'">
    <div class="modal-box" onclick="event.stopPropagation()">
        <div class="modal-header">
            <h3 class="modal-title">é€‰æ‹©å¤‡é€‰æº</h3>
            <button onclick="document.getElementById('sourceModal').style.display='none'" style="border:none; background:none; font-size:20px; cursor:pointer;">Ã—</button>
        </div>
        <div class="source-title-row">
            <input id="sourceTitleInput" class="p-input source-title-input" placeholder="ä¹¦åè¯†åˆ«é”™è¯¯ï¼Ÿå¯æ‰‹åŠ¨è¾“å…¥" />
            <button class="source-search-btn" onclick="loadSourceList(true)">é‡æ–°æœç´¢</button>
        </div>
        <div id="sourceLoading" style="text-align:center; padding:20px; color:#999;">ğŸ” æ­£åœ¨åŒ¹é…å¯ç”¨æºç«™...ï¼ˆé¢„è®¡ 5~15 ç§’ï¼‰</div>
        <div id="sourceList"></div>
    </div>
</div>

<div id="toast"></div>
<!-- åˆ†äº« Modal -->
<div id="shareModal" class="modal-overlay" onclick="this.style.display='none'">
    <div class="modal-box" onclick="event.stopPropagation()" style="max-width: 380px;">
        <div class="modal-header">
            <h3 class="modal-title">ğŸ“¤ åˆ†äº«æœ¬ä¹¦</h3>
            <button onclick="document.getElementById('shareModal').style.display='none'" style="border:none; background:none; font-size:20px; cursor:pointer;">Ã—</button>
        </div>
        
        <div class="share-body">
            <!-- 1. æ–‡æ¡ˆé¢„è§ˆåŒº -->
            <div class="share-text-area">
                <textarea id="shareTextArea" readonly></textarea>
                <button class="btn-copy" onclick="copyShareText()">ğŸ“‹ å¤åˆ¶åˆ†äº«æ–‡æ¡ˆ</button>
            </div>

            <div class="share-divider"><span>OR</span></div>

            <!-- 2. äºŒç»´ç åŒº -->
            <div class="qr-section">
                <div id="qrcode"></div>
                <p class="qr-tip">æ‰‹æœºæ‰«ç æ¥ç€çœ‹</p>
            </div>
        </div>
    </div>
</div>

<script>
    let localChapterId = parseInt("{{ chapter_id }}") || -1;
    const dbKey = "{{ db_key }}";
    // ä»åç«¯è·å–å½“å‰é¡µé¢å¯¹åº”çš„ URL (é€šå¸¸æ˜¯æœªç¼–ç æˆ–éƒ¨åˆ†ç¼–ç çš„)
    let currentUrl = "{{ current_url }}"; // å…è®¸ AJAX å¯¼èˆªåæ›´æ–°å½“å‰ç« èŠ‚ URL
    // è‡ªåŠ¨æ³¨å…¥ç‰ˆæœ¬å·
    const APP_VERSION = "{{ app_version }}";
    let isSubscribed = false;
    
    // [æ–°å¢] ä¿å­˜åˆ°ï¿½ï¿½æ¶åŠŸèƒ½
    let isSaved = false;
    
    async function saveToShelf() {
        const btn = document.getElementById('saveToShelfBtn');
        
        // å¦‚æœå·²ç»æœ‰ keyï¼Œè¯´æ˜å·²åœ¨ä¹¦æ¶
        if (dbKey) {
            try {
                // æ£€æŸ¥æ˜¯å¦çœŸçš„å­˜åœ¨äºæ•°æ®åº“
                const checkRes = await fetch('/find', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ key: dbKey })
                });
                const checkData = await checkRes.json();
                
                if (checkData.status === 'success' && checkData.value) {
                    // å·²å­˜åœ¨
                    alert('âœ… è¯¥ä¹¦ç±å·²åœ¨ä¹¦æ¶ä¸­');
                    btn.classList.add('saved');
                    return;
                }
            } catch(e) {
                console.error(e);
            }
        }
        
        // éœ€è¦è·å–ç›®å½• URL
        if (!dbKey || !currentUrl) {
            alert('âŒ ç¼ºå°‘å¿…è¦ä¿¡æ¯ï¼Œæ— æ³•ä¿å­˜');
            return;
        }
        
        btn.style.opacity = '0.5';
        btn.style.pointerEvents = 'none';
        
        try {
            // è·å–ç›®å½• URL
            let tocUrl = currentUrl;
            
            // å¦‚æœå½“å‰æ˜¯ç« èŠ‚é¡µï¼Œå°è¯•ä» article.toc_url è·å–
            const tocData = await fetch(`/toc?url=${encodeURIComponent(currentUrl)}&key=${encodeURIComponent(dbKey || 'temp')}&api=1`);
            const toc = await tocData.json();
            
            // ä½¿ç”¨é¡µé¢æä¾›çš„ç›®å½•é“¾æ¥æˆ–å½“å‰ URL
            const tocLink = "{{ article.toc_url or '' }}";
            if (tocLink) {
                tocUrl = tocLink;
            }
            
            // è°ƒç”¨å¿«é€Ÿä¿å­˜ API
            const res = await fetch('/api/quick_save', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ 
                    key: dbKey,
                    url: tocUrl
                })
            });
            
            const result = await res.json();
            
            if (result.status === 'success') {
                alert('âœ… ' + result.message);
                btn.classList.add('saved');
                isSaved = true;
            } else {
                alert('âŒ ' + (result.message || 'ä¿å­˜å¤±è´¥'));
            }
        } catch(e) {
            console.error(e);
            alert('âŒ ä¿å­˜å¤±è´¥ï¼š' + e.message);
        } finally {
            btn.style.opacity = '1';
            btn.style.pointerEvents = 'auto';
        }
    }
    
    // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥æ˜¯å¦å·²ä¿å­˜
    async function checkIfSaved() {
        if (!dbKey) return;
        
        try {
            const res = await fetch('/find', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ key: dbKey })
            });
            const data = await res.json();
            
            if (data.status === 'success' && data.value) {
                const btn = document.getElementById('saveToShelfBtn');
                if (btn) {
                    btn.classList.add('saved');
                    btn.title = 'å·²åœ¨ä¹¦æ¶ä¸­';
                }
                isSaved = true;
            }
        } catch(e) {
            console.error(e);
        }
    }
    
    async function checkSubPC() {
        try {
            const res = await fetch('/api/updates/status', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ key: dbKey })
            });
            const json = await res.json();
            isSubscribed = json.subscribed;
            updateSubBtnUI();
        } catch(e) {}
    }
    
    function updateSubBtnUI() {
        const btn = document.getElementById('pcSubBtn');
        if (isSubscribed) {
            btn.innerHTML = '<span>ğŸ”¥</span> å·²è¿½æ›´';
            btn.style.borderColor = "#e11d48";
            btn.style.color = "#e11d48";
            btn.style.background = "#fff1f2";
        } else {
            btn.innerHTML = '<span>ğŸ””</span> å¼€å¯è¿½æ›´';
            btn.style.borderColor = "";
            btn.style.color = "";
            btn.style.background = "";
        }
    }
    
    async function toggleSubscribePC() {
        const tocUrl = "{{ article.toc_url }}" || "{{ current_url }}";
        // ç®€å•æ­£åˆ™æå–ID
        let cid = 0;
        const m = "{{ current_url }}".match(/\/(\d+)(?:_\d+)?(?:\.html)?$/);
        if (m) cid = parseInt(m[1]);
        
        const res = await fetch('/api/updates/subscribe', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ 
                key: dbKey, 
                enable: !isSubscribed, 
                toc_url: tocUrl,
                current_id: cid
            })
        });
        const json = await res.json();
        if (json.status === 'success') {
            showToast(json.msg);
            isSubscribed = !isSubscribed;
            updateSubBtnUI();
        }
    }
    
    // åˆå§‹åŒ–
    checkSubPC();
    function getPageIndex(url) {
        const match = url.match(/_(\d+)\./);
        return match ? parseInt(match[1]) : 1;
    }
    function changeFontFamily(fontName) {
        document.documentElement.style.setProperty('--font-main', fontName);
        localStorage.setItem('pc_reader_font', fontName);
        
        // å¦‚æœè¿™æ˜¯ä¸€ä¸ªè‡ªå®šä¹‰çš„ç½‘ç»œå­—ä½“ URLï¼Œæˆ‘ä»¬ä¹Ÿå­˜ä¸€ä¸‹ URLï¼Œæ–¹ä¾¿ä¸‹æ¬¡è‡ªåŠ¨åŠ è½½
        // (é€»è¾‘ï¼šå¦‚æœ fontName ä¸åœ¨é¢„è®¾åˆ—è¡¨é‡Œï¼Œå¯èƒ½å°±æ˜¯ Web Font)
        const selector = document.getElementById('fontSelector');
        if (selector.value === fontName && fontName.startsWith("'CustomWebFont'")) {
             // Web Font çš„æŒä¹…åŒ–åœ¨ loadCustomWebFont é‡Œå•ç‹¬å¤„ç†
        }
    }

    // 2. æ–¹æ¡ˆBï¼šæ‰«ææœ¬åœ°å­—ä½“ (Chrome/Edge/Electron)
    async function detectLocalFonts() {
        if (!('queryLocalFonts' in window)) {
            showToast("âŒ å½“å‰æµè§ˆå™¨ä¸æ”¯æŒè®¿é—®æœ¬åœ°å­—ä½“");
            return;
        }

        const btn = document.querySelector('button[onclick="detectLocalFonts()"]');
        btn.innerText = "â³";
        
        try {
            // è¯·æ±‚æƒé™å¹¶è·å–åˆ—è¡¨
            const availableFonts = await window.queryLocalFonts();
            const selector = document.getElementById('fontSelector');
            
            // å»é‡
            const uniqueFonts = [...new Set(availableFonts.map(f => f.family))].sort();
            
            // åˆ›å»ºåˆ†ç»„
            let group = document.getElementById('local-font-group');
            if (!group) {
                group = document.createElement('optgroup');
                group.id = 'local-font-group';
                group.label = "æœ¬åœ°å·²å®‰è£…";
                selector.appendChild(group);
            }
            group.innerHTML = ''; // æ¸…ç©ºæ—§çš„

            // å¡«å……ä¸‹æ‹‰æ¡†
            uniqueFonts.forEach(family => {
                const option = document.createElement('option');
                option.value = `"${family}", sans-serif`;
                option.innerText = family;
                group.appendChild(option);
            });

            showToast(`âœ… æ‰«æåˆ° ${uniqueFonts.length} æ¬¾å­—ä½“`);
            btn.innerText = "ğŸ”";
            
        } catch (err) {
            console.error(err);
            showToast("âŒ æ‰«æå–æ¶ˆæˆ–å¤±è´¥");
            btn.innerText = "ğŸ”";
        }
    }

    // 3. æ–¹æ¡ˆDï¼šåŠ è½½ç½‘ç»œå­—ä½“ (æ™ºèƒ½è¯†åˆ« CSS æˆ– æ–‡ä»¶)
    async function loadCustomWebFont(savedUrl = null) {
        const urlInput = document.getElementById('webFontUrl');
        const url = savedUrl || urlInput.value.trim();
        
        if (!url) return showToast("è¯·è¾“å…¥å­—ä½“é“¾æ¥");

        const btn = document.querySelector('button[onclick="loadCustomWebFont()"]');
        if(!savedUrl) btn.innerText = "â³";

        try {
            const fontName = 'CustomWebFont-' + Date.now(); // ç”Ÿæˆå”¯ä¸€å­—ä½“å
            
            // æƒ…å†µ A: è¾“å…¥çš„æ˜¯ CSS æ–‡ä»¶ (å¦‚ Google Fonts, lxgw static css)
            if (url.endsWith('.css') || url.includes('googleapis.com')) {
                const link = document.createElement('link');
                link.href = url;
                link.rel = 'stylesheet';
                document.head.appendChild(link);
                // CSS åŠ è½½è¾ƒéš¾å›è°ƒï¼Œæˆ‘ä»¬å‡è®¾å®ƒä¼šè¦†ç›– font-familyï¼Œ
                // ä½†å®é™…ä¸Š CSS é“¾æ¥é€šå¸¸éœ€è¦ç”¨æˆ·çŸ¥é“ CSS é‡Œå®šä¹‰çš„ font-family åå­—ã€‚
                // ä¸ºäº†ç®€åŒ–ï¼Œæˆ‘ä»¬å»ºè®®ç”¨æˆ·ä½¿ç”¨ .woff2/.ttf ç›´é“¾ï¼Œ
                // æˆ–è€…æˆ‘ä»¬å¯ä»¥å°è¯•è§£æ CSS (å¤ªå¤æ‚)ã€‚
                // å¦¥åæ–¹æ¡ˆï¼šæç¤ºç”¨æˆ·è¾“å…¥ CSS é‡Œçš„å­—ä½“åï¼Œæˆ–è€…æˆ‘ä»¬åªæ”¯æŒç›´é“¾æ–‡ä»¶ã€‚
                
                // è¿™é‡Œæˆ‘ä»¬åšä¸ªâ€œç›´é“¾æ–‡ä»¶â€çš„ä¼˜å…ˆæ”¯æŒã€‚å¦‚æœæ˜¯ CSSï¼Œæˆ‘ä»¬åªæ˜¯å¼•å…¥å®ƒï¼Œ
                // ç”¨æˆ·ä»éœ€åœ¨ä¸‹æ‹‰æ¡†é€‰æ‹©ï¼ˆå¦‚æœçŸ¥é“åå­—ï¼‰ã€‚
                // ä½†ä¸ºäº†ä½“éªŒï¼Œæˆ‘ä»¬ä¸»è¦æ”¯æŒ font fileã€‚
                showToast("CSS å·²æ³¨å…¥ï¼Œè¯·ç¡®ä¿ä½ çŸ¥é“å­—ä½“åç§°");
            } 
            // æƒ…å†µ B: è¾“å…¥çš„æ˜¯å­—ä½“æ–‡ä»¶ (.woff2, .ttf, .otf)
            else {
                const fontFace = new FontFace('UserWebFont', `url(${url})`);
                await fontFace.load();
                document.fonts.add(fontFace);
                
                // æ·»åŠ åˆ°ä¸‹æ‹‰æ¡†å¹¶é€‰ä¸­
                const selector = document.getElementById('fontSelector');
                let group = document.getElementById('web-font-group');
                if (!group) {
                    group = document.createElement('optgroup');
                    group.id = 'web-font-group';
                    group.label = "ç½‘ç»œå­—ä½“";
                    selector.prepend(group); // æ”¾åœ¨æœ€å‰
                }
                
                // æ¸…ç†æ—§çš„ WebFont é€‰é¡¹
                group.innerHTML = `<option value="'UserWebFont', sans-serif">å½“å‰ç½‘ç»œå­—ä½“</option>`;
                selector.value = "'UserWebFont', sans-serif";
                
                // åº”ç”¨
                changeFontFamily("'UserWebFont', sans-serif");
                
                // æŒä¹…åŒ– URL
                localStorage.setItem('pc_reader_webfont_url', url);
                if(!savedUrl) showToast("âœ… ç½‘ç»œå­—ä½“å·²åº”ç”¨");
            }
        } catch (e) {
            console.error(e);
            if(!savedUrl) showToast("âŒ å­—ä½“åŠ è½½å¤±è´¥: " + e.message);
        } finally {
            if(!savedUrl) btn.innerText = "â˜ï¸ åŠ è½½";
        }
    }
    // åˆ¤æ–­æ˜¯å¦åº”è¯¥åŒæ­¥
    function shouldSync(remoteUrl, remoteMeta) {
        if (currentUrl.startsWith('epub:')) return false;
        
        console.log('[Sync Debug] æ¯”å¯¹å‚æ•°:', {
            currentUrl,
            remoteUrl,
            remoteMeta,
            localChapterId
        });
        
        // 1. URL ç›¸åŒï¼Œç›´æ¥è·³è¿‡
        if (normalizeUrl(currentUrl) === normalizeUrl(remoteUrl)) {
            console.log('[Sync] URLç›¸åŒï¼Œæ— éœ€åŒæ­¥');
            return false;
        }

        // 2. [æ ¸å¿ƒ] ID æ¯”å¯¹ (æ•´æ•°æ¯”å¤§å°)
        // remoteMeta.chapter_id æ˜¯åç«¯æ ¹æ®å­˜å…¥æ—¶çš„æ ‡é¢˜ç®—å‡ºæ¥çš„ï¼Œç»å¯¹å‡†ç¡®
        // localChapterId æ˜¯åç«¯æ¸²æŸ“å½“å‰é¡µæ—¶ç®—å‡ºæ¥çš„ï¼Œç»å¯¹å‡†ç¡®
        if (remoteMeta && remoteMeta.chapter_id > 0 && localChapterId > 0) {
            if (remoteMeta.chapter_id > localChapterId) {
                console.log(`[Sync] è¿œç¨‹ID(${remoteMeta.chapter_id}) > æœ¬åœ°ID(${localChapterId}) -> æç¤ºæ›´æ–°`);
                return true;
            }
            // è¿œç¨‹ <= æœ¬åœ°ï¼Œè¯´æ˜æœ¬åœ°æ˜¯æœ€æ–°çš„ï¼Œæ— éœ€æç¤º
            console.log(`[Sync] è¿œç¨‹ID(${remoteMeta.chapter_id}) <= æœ¬åœ°ID(${localChapterId}) -> æ— éœ€åŒæ­¥`);
            return false;
        }

        // 3. å…œåº•ï¼šå¦‚æœæ²¡ IDï¼Œåªèƒ½ççŒœ (URL ä¸åŒå°±æç¤º)
        console.log('[Sync] ç¼ºå°‘ç« èŠ‚IDï¼Œä½¿ç”¨URLæ¯”å¯¹ï¼ˆå…œåº•ï¼‰');
        return true; 
    }
    document.addEventListener('keydown', (e) => {
    // 1. M é”®å¿«é€Ÿæ‰“å¼€/å…³é—­ç›®å½• (Menu)
    if (e.key.toLowerCase() === 'm' && document.activeElement.tagName !== 'INPUT') {
        const toc = document.getElementById('tocOverlay');
        toc.style.display === 'none' ? showModal('tocOverlay') : toc.style.display = 'none';
    }

    // 2. T é”®å¼€å¯/åœæ­¢ TTS æœ—è¯» (Talk)
    if (e.key.toLowerCase() === 't' && document.activeElement.tagName !== 'INPUT') {
        toggleTTS();
    }

    // 3. æ•°å­—é”® 1, 2, 3, 4 åˆ‡æ¢èƒŒæ™¯ä¸»é¢˜
    if (!e.ctrlKey && ['1','2','3','4'].includes(e.key)) {
       const themes = ['light', 'sepia', 'green', 'dark'];
       // è¿™é‡Œå¯ä»¥è°ƒç”¨ä½ ä¹‹å‰çš„ setTheme æˆ– toggleDarkMode é€»è¾‘
    }
});
    // === [å·¥å…·] URL å¼ºåŠ›å½’ä¸€åŒ– (è§£å†³åŒæ­¥è¯¯æŠ¥æ ¸å¿ƒ) ===
    function normalizeUrl(url) {
        if (!url) return "";
        let res = url;
        try {
            // é€’å½’è§£ç ï¼Œç›´åˆ°ä¸å†å˜åŒ– (è§£å†³ %253A ç­‰å¤šé‡ç¼–ç )
            while (decodeURIComponent(res) !== res) {
                res = decodeURIComponent(res);
            }
        } catch (e) {}
        // å»é™¤æœ«å°¾æ–œæ 
        if (res.endsWith('/')) res = res.slice(0, -1);
        return res.trim();
    }

    // === åˆå§‹åŒ–å…¥å£ ===
    window.onload = function() {
        // 1. è·å–ç”¨æˆ·ä¿¡æ¯
        fetch('/api/me').then(r=>r.json()).then(u => {
            if(u.username) document.getElementById('userName').innerText = u.username;
            if(u.avatar) document.getElementById('userAvatar').src = u.avatar;
        });

        // 2. åŠ è½½ç”¨æˆ·åå¥½ (å­—å·ã€é¢œè‰²ã€å¤œé—´æ¨¡å¼)
        initCustomColors();
        initPreferences();

        // 3. [æ ¸å¿ƒ] å¯åŠ¨åŒæ­¥æ£€æŸ¥ (å…ˆæ£€æŸ¥ï¼Œæ— å†²çªå†è‡ªåŠ¨ä¿å­˜)
        checkRemoteAndInit(); 

        // 4. å¯åŠ¨åå°ä»»åŠ¡
        setInterval(sendHeartbeat, 60000); // 1åˆ†é’Ÿä¸€æ¬¡å¿ƒè·³
        reportWordCount();                 // ä¸ŠæŠ¥å­—æ•°
        handlePrefetch();                  // é¢„åŠ è½½ä¸‹ä¸€ç« 
        
        // 5. [æ–°å¢] æ£€æŸ¥æ˜¯å¦å·²ä¿å­˜åˆ°ä¹¦æ¶
        checkIfSaved();
    };

    // === åŒæ­¥æ ¸å¿ƒé€»è¾‘ (Check First, Save Later) ===
    async function checkRemoteAndInit() {
        if(!dbKey) return;
        try {
            const res = await fetch('/api/get_value', { 
                method: 'POST', 
                headers: {'Content-Type': 'application/json'}, 
                body: JSON.stringify({ key: dbKey }) 
            });
            const d = await res.json();
            
            console.log('[Sync Debug] è·å–è¿œç¨‹è¿›åº¦:', d);  // è°ƒè¯•æ—¥å¿—
            
            if (d.status === 'success' && d.value) {
                // ä¼ å…¥ meta æ•°æ®è¿›è¡Œæ™ºèƒ½å¯¹æ¯”
                if (shouldSync(d.value, d.meta)) {
                    console.log("[Sync] å‘ç°æ›´æ–°çš„è¿œç¨‹è¿›åº¦ï¼Œæš‚åœè‡ªåŠ¨ä¿å­˜ã€‚");
                    showSyncAlert(d.value);
                } else {
                    // è¿œç¨‹æ²¡æˆ‘æ–°ï¼Œæˆ–è€…ä¸€æ · -> å¼€å¯è‡ªåŠ¨ä¿å­˜ (è¦†ç›–è¿œç¨‹)
                    autoSyncProgress();
                }
            } else {
                autoSyncProgress();
            }
        } catch (e) { console.error(e); }
        
        setInterval(checkRemoteLoop, 5000);
    }

    // è½®è¯¢æ£€æŸ¥ (ä»…æç¤ºï¼Œä¸è‡ªåŠ¨è·³è½¬)
    function checkRemoteLoop() {
        if(!dbKey) return;
        fetch('/api/get_value', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ key: dbKey }) })
        .then(r => r.json()).then(d => {
            if (d.status === 'success' && d.value) {
                // è½®è¯¢æ—¶ä¹Ÿä½¿ç”¨æ™ºèƒ½å¯¹æ¯”
                if (shouldSync(d.value, d.meta)) {
                    showSyncAlert(d.value);
                } else {
                    // åªè¦æœ¬åœ° >= è¿œç¨‹ï¼Œå°±éšè—æç¤º
                    document.getElementById('syncAlert').classList.remove('active');
                }
            }
        });
    }

    // æ˜¾ç¤ºåŒæ­¥æç¤ºæ¡
    function showSyncAlert(targetUrl) {
        const link = document.getElementById('syncLink');
        if(link) {
            link.href = `/read?url=${encodeURIComponent(targetUrl)}&key=${dbKey}`;
            document.getElementById('syncAlert').classList.add('active');
        }
    }
    function closeSyncAlert() {
        document.getElementById('syncAlert').classList.remove('active')
        autoSyncProgress();
    }
    // æ‰§è¡Œä¿å­˜ (æ›´æ–°é˜…è¯»è¿›åº¦)
    // æ‰§è¡Œä¿å­˜
    function autoSyncProgress() {
        if(!dbKey) return;
        
        // è·å–å½“å‰æ ‡é¢˜ (ç”¨äºåç«¯è®¡ç®—çœŸå®ID)
        const currentTitle = document.getElementById('chapterTitle')?.innerText || '';
        
        // [æ–°å¢] è°ƒè¯•æ—¥å¿—
        console.log(`[Sync] ä¿å­˜è¿›åº¦: ä¹¦ç±=${dbKey}, URL=${currentUrl}, æ ‡é¢˜="${currentTitle}", æœ¬åœ°ID=${localChapterId}`);

        fetch('/api/last_read', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ key: dbKey }) });
        
        fetch('/update', { 
            method: 'POST', 
            headers: {'Content-Type': 'application/json'}, 
            body: JSON.stringify({ 
                key: dbKey, 
                value: currentUrl,
                title: currentTitle // <--- [æ–°å¢] å¿…é¡»å¸¦ä¸Šæ ‡é¢˜ï¼
            }) 
        });
    }

    // === UI äº¤äº’é€»è¾‘ ===
    function showModal(id) {
        document.getElementById(id).style.display = 'flex';
        if(id === 'tocOverlay') loadTOC(false);
        if(id === 'statsModal') loadStats(); // åŠ è½½çƒ­åŠ›å›¾
    }

    // å¼ºåˆ¶åˆ·æ–°
    function forceRefresh() {
        showToast("ğŸ”„ æ­£åœ¨å¼ºåˆ¶åˆ·æ–°é¡µé¢...");
        const url = new URL(window.location.href);
        url.searchParams.set('force', 'true');
        window.location.href = url.toString();
    }
    const originalInitPrefs = initPreferences; // ä¿å­˜æ—§å¼•ç”¨
    initPreferences = function() {
        // è°ƒç”¨æ—§çš„åˆå§‹åŒ– (å­—å·ã€å¤œé—´æ¨¡å¼)
        if(originalInitPrefs) originalInitPrefs();

        // æ¢å¤ä¿å­˜çš„å­—ä½“
        const savedFont = localStorage.getItem('pc_reader_font');
        const selector = document.getElementById('fontSelector');
        
        // å°è¯•æ¢å¤ç½‘ç»œå­—ä½“
        const savedWebFontUrl = localStorage.getItem('pc_reader_webfont_url');
        if (savedWebFontUrl) {
            // å¦‚æœä¸Šæ¬¡ç”¨çš„æ˜¯ç½‘ç»œå­—ä½“ï¼Œå…ˆé™é»˜åŠ è½½
            loadCustomWebFont(savedWebFontUrl);
            // è¿™é‡Œ loadCustomWebFont å†…éƒ¨ä¼šè®¾ç½® selector.value
        } else if (savedFont) {
            // æ™®é€šå­—ä½“ï¼Œç›´æ¥è®¾ç½®
            // æ³¨æ„ï¼šå¦‚æœ savedFont æ˜¯æœ¬åœ°æ‰«æçš„å­—ä½“ï¼Œä¸‹æ‹‰æ¡†é‡Œå¯èƒ½è¿˜æ²¡æœ‰è¿™ä¸ªé€‰é¡¹
            if (![...selector.options].some(o => o.value === savedFont)) {
                const opt = document.createElement('option');
                opt.value = savedFont;
                opt.innerText = savedFont.replace(/"/g, '').split(',')[0];
                selector.add(opt);
            }
            selector.value = savedFont;
            document.documentElement.style.setProperty('--font-main', savedFont);
        }
    };
    // è®¾ç½®ç›¸å…³
    function initPreferences() {
        const fs = parseInt(localStorage.getItem('pc_reader_fs')) || 19;
        const slider = document.getElementById('fontSlider');
        if(slider) slider.value = fs;
        updateFS(fs, false);
        if(localStorage.getItem('pc_reader_dark') === 'true') document.body.classList.add('dark-mode');
    }

    function updateFS(val, save = true) {
        document.getElementById('articleBody').style.fontSize = val + 'px';
        const disp = document.getElementById('fontVal');
        if(disp) disp.innerText = val;
        if(save) localStorage.setItem('pc_reader_fs', val);
    }

    function toggleDarkMode() {
        document.body.classList.toggle('dark-mode');
        const isDark = document.body.classList.contains('dark-mode');
        localStorage.setItem('pc_reader_dark', isDark);
    }

    // è‡ªå®šä¹‰é¢œè‰²
    function initCustomColors() {
        const savedColors = JSON.parse(localStorage.getItem('pc_custom_colors') || '{}');
        const root = document.documentElement;
        if (savedColors.outer) {
            root.style.setProperty('--bg-outer', savedColors.outer);
            const p = document.getElementById('bgOuterPicker'); if(p) p.value = savedColors.outer;
        }
        if (savedColors.reader) {
            root.style.setProperty('--bg-reader', savedColors.reader);
            const p = document.getElementById('bgReaderPicker'); if(p) p.value = savedColors.reader;
        }
    }
    function updateCustomColor(type, color) {
        const root = document.documentElement;
        if (type === 'outer') root.style.setProperty('--bg-outer', color);
        else if (type === 'reader') root.style.setProperty('--bg-reader', color);
        
        const currentSaved = JSON.parse(localStorage.getItem('pc_custom_colors') || '{}');
        currentSaved[type] = color;
        localStorage.setItem('pc_custom_colors', JSON.stringify(currentSaved));
    }
    function resetCustomColors() {
        const root = document.documentElement;
        root.style.removeProperty('--bg-outer');
        root.style.removeProperty('--bg-reader');
        localStorage.removeItem('pc_custom_colors');
        document.getElementById('bgOuterPicker').value = '#e0e0e0';
        document.getElementById('bgReaderPicker').value = '#f2f2f2';
        showToast("å·²æ¢å¤é»˜è®¤é…è‰²");
    }

    // === ç›®å½•åŠ è½½ ===
    function loadTOC(force = false) {
        const list = document.getElementById('tocList');
        if(force) showToast("ğŸ” æ­£åœ¨é‡æ–°çˆ¬å–ç›®å½•...");
        list.innerHTML = force ? 'æ­£åœ¨åˆ·æ–°ç›®å½•ï¼Œè¯·ç¨å€™...' : 'æ­£åœ¨åŠ è½½...';
        
        const normCurrent = normalizeUrl(currentUrl);

        fetch(`/toc?url={{ article.toc_url }}&key=${dbKey}&api=true${force ? '&force=true' : ''}`)
        .then(r => r.json())
        .then(d => {
            if(d.chapters && d.chapters.length > 0) {
                // å¼ºåˆ¶æ’åº
                d.chapters.sort((a, b) => (a.id || 0) - (b.id || 0));
                
                list.innerHTML = d.chapters.map(c => {
                    const isCurrent = normalizeUrl(c.url) === normCurrent;
                    
                    // [ä¿®å¤] ä¼˜å…ˆä½¿ç”¨ titleï¼Œè§£å†³ undefined é—®é¢˜
                    let nameText = c.title || c.name || c.raw_title || "æ— æ ‡é¢˜";
                    let displayTitle = nameText;

                    // [ä¿®å¤] æ™ºèƒ½åˆ¤æ–­ ID ç±»å‹ï¼š
                    // åªæœ‰å½“ id æ˜¯åˆç†çš„çŸ­åºå·(å°äº 100000)æ—¶ï¼Œæ‰æ‹¼æ¥ "ç¬¬xç« "
                    // é¿å…æŠŠ 19 ä½é•¿çš„æ•°æ®åº“ ID å½“ä½œç« èŠ‚å·æ˜¾ç¤º
                    if (c.id && c.id > 0 && c.id < 100000) {
                         // é˜²æ­¢æ ‡é¢˜é‡Œæœ¬æ¥å°±æœ‰"ç¬¬xç« "ï¼Œå¯¼è‡´é‡å¤
                         if (!nameText.includes('ç¬¬')) {
                             displayTitle = `ç¬¬${c.id}ç«  ${nameText}`;
                         }
                    }

                    return `<a href="/read?url=${encodeURIComponent(c.url)}&key=${dbKey}" 
                               class="toc-item ${isCurrent ? 'active-chap' : ''}">
                               ${displayTitle}
                            </a>`;
                }).join('');

                // è‡ªåŠ¨æ»šåŠ¨
                setTimeout(() => {
                    const activeItem = list.querySelector('.active-chap');
                    if (activeItem) activeItem.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }, 100);

                if(force) showToast("âœ… ç›®å½•å·²æ›´æ–°");
            } else { 
                list.innerText = "è·å–ç›®å½•å¤±è´¥"; 
            }
        })
        .catch(e => {
            console.error(e);
            list.innerText = "ç½‘ç»œå¼‚å¸¸";
        });
    }

    // === åˆ†äº«åŠŸèƒ½ ===
    function openShareModal() {
        document.getElementById('settingsModal').style.display = 'none';
        document.getElementById('shareModal').style.display = 'flex';
        
        const title = document.getElementById('chapterTitle').innerText;
        const shareUrl = window.location.href;
        const shareText = `ğŸ“– æ­£åœ¨é˜…è¯»\n${title}\n\nğŸ”— ç‚¹å‡»é“¾æ¥ç›´æ¥é˜…è¯»ï¼š\n${shareUrl}`;
        
        document.getElementById('shareTextArea').value = shareText;
        
        const qrContainer = document.getElementById('qrcode');
        qrContainer.innerHTML = ""; 
        new QRCode(qrContainer, {
            text: shareUrl, width: 160, height: 160,
            colorDark : "#000000", colorLight : "#ffffff",
            correctLevel : QRCode.CorrectLevel.L
        });
    }
    function copyShareText() {
        document.getElementById('shareTextArea').select();
        document.execCommand("copy");
        showToast("âœ… æ–‡æ¡ˆå·²å¤åˆ¶");
    }
    async function nativeShare() {
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        if (isMobile && navigator.share) {
            try { await navigator.share({ title: document.title, text: 'å¥½ä¹¦åˆ†äº«', url: window.location.href }); } catch (err) {}
        } else {
            openShareModal();
        }
    }

    // === æ¢æºé€»è¾‘ ===
    let switchContext = {}; // ä¸Šä¸‹æ–‡

    function getSourceTitleStorageKey() {
        return `pc_manual_source_title_${dbKey || 'unknown'}`;
    }
    function saveManualSourceTitle(value) {
        try {
            const key = getSourceTitleStorageKey();
            if (!key) return;
            if (value) localStorage.setItem(key, value);
            else localStorage.removeItem(key);
        } catch (e) {}
    }
    function loadManualSourceTitle() {
        try {
            const input = document.getElementById('sourceTitleInput');
            if (!input) return;
            const saved = localStorage.getItem(getSourceTitleStorageKey());
            if (saved && !input.value) input.value = saved;
        } catch (e) {}
    }
    function bindManualSourceTitleInput() {
        const input = document.getElementById('sourceTitleInput');
        if (!input || input.dataset.bound) return;
        input.dataset.bound = 'true';
        input.addEventListener('input', () => {
            const v = input.value.trim();
            saveManualSourceTitle(v);
        });
    }
    function initManualSourceTitle() {
        loadManualSourceTitle();
        bindManualSourceTitleInput();
    }

    function getManualSourceTitle() {
        const input = document.getElementById('sourceTitleInput');
        return input ? input.value.trim() : '';
    }

    function triggerSourceModal() {
        document.getElementById('settingsModal').style.display = 'none';
        showModal('sourceModal');
        initManualSourceTitle();
        loadSourceList();
    }
    async function loadSourceList(force = false) {
        const list = document.getElementById('sourceList');
        const loading = document.getElementById('sourceLoading');
        list.innerHTML = ''; loading.style.display = 'block';
        loading.innerText = 'ğŸ” æ­£åœ¨èšåˆå…¨ç½‘æœç´¢ç»“æœ...';
        const manualTitle = getManualSourceTitle();
        saveManualSourceTitle(manualTitle);
        
        try {
            const res = await fetch('/api/source/list', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    key: dbKey,
                    url: currentUrl,
                    title: document.getElementById('chapterTitle').innerText,
                    manual_book_name: manualTitle,
                    force
                })
            });
            const json = await res.json();
            loading.style.display = 'none';
            if (json.status === 'success') {
                switchContext = json.match_info || {};
                switchContext.current_title = switchContext.current_title || document.getElementById('chapterTitle').innerText;
                list.innerHTML = json.data.map(src => {
                    let domain = '';
                    try { domain = new URL(src.url).hostname; } catch(e) { domain = src.url; }
                    
                    return `
                    <div onclick="requestSwitch(${JSON.stringify(src.url || '')}, ${JSON.stringify(src.source || '')})" 
                         style="padding:15px; border:1px solid #eee; border-radius:10px; margin-bottom:10px; cursor:pointer; transition:all 0.2s; background:#fff;" 
                         onmouseover="this.style.borderColor='var(--accent)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.05)'" 
                         onmouseout="this.style.borderColor='#eee'; this.style.boxShadow='none'">
                        
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px;">
                            <div style="font-weight:bold; color: #333; font-size:15px;">${escapeHtml(src.source || '')}</div>
                            <div style="font-size:12px; color:#888;">${escapeHtml(src.description || '')}</div>
                        </div>

                        <div style="font-size:13px; color:#555; margin-bottom:8px;">${escapeHtml(src.title || '')}</div>
                        
                        <div style="font-size:11px; color:#999; background:#f9f9f9; padding:4px 8px; border-radius:4px; font-family:monospace; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">
                            ${escapeHtml(src.url || '')}
                        </div>
                    </div>`;
                }).join('');
            } else { list.innerHTML = `<div style="text-align:center; padding: 20px;">${escapeHtml(json.msg || '')}</div>`; }
        } catch(e) { showToast("æ¢æºæœåŠ¡æš‚æ—¶ä¸å¯ç”¨"); }
    }
    async function requestSwitch(targetUrl, sourceName) {
        const list = document.getElementById('sourceList');
        const loading = document.getElementById('sourceLoading');
        
        list.parentElement.scrollTop = 0; // æ»šå›é¡¶éƒ¨
        list.style.display = 'none';
        loading.style.display = 'block';
        loading.innerHTML = `â³ æ­£åœ¨å‰å¾€ ${escapeHtml(sourceName || '')}<br>å°è¯•åŒ¹é…ç« èŠ‚...`;

        try {
            const res = await fetch('/api/source/confirm_switch', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    target_url: targetUrl,
                    current_id: switchContext.current_id,
                    current_title: switchContext.current_title
                })
            });
            
            const json = await res.json();
            
            if (json.status === 'success') {
                loading.innerText = 'âœ… è·³è½¬ä¸­...';
                await fetch('/update', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ key: dbKey, value: json.new_url }) });
                window.location.href = `/read?url=${encodeURIComponent(json.new_url)}&key=${encodeURIComponent(dbKey)}`;
            } else {
                showToast(json.msg || "åˆ‡æ¢å¤±è´¥");
                loading.style.display = 'none';
                list.style.display = 'block';
            }
        } catch (e) {
            showToast("è¯·æ±‚è¶…æ—¶");
            loading.style.display = 'none';
            list.style.display = 'block';
        }
    }

    // async function confirmSwitch(newUrl) { ... }
    // === ç»Ÿè®¡ä¸çƒ­åŠ›å›¾ ===
    async function loadStats() {
        const grid = document.getElementById('heatmapGrid');
        grid.innerHTML = '<div style="text-align:center; width:100%; grid-column:span 30;">åŠ è½½ä¸­...</div>';
        try {
            const res = await fetch('/api/analyze_stats');
            const json = await res.json();
            if (json.status === 'success') {
                const summary = json.summary;
                document.getElementById('statTotalTime').innerText = (summary.all.time / 60).toFixed(1);
                document.getElementById('statTotalWords').innerText = (summary.all.words / 10000).toFixed(2);
                document.getElementById('statToday').innerText = summary['24h'].time;

                const heatmapMap = {};
                summary.all.heatmap.forEach(h => heatmapMap[h.date] = h.count);

                let html = '';
                for (let i = 29; i >= 0; i--) {
                    const d = new Date(); d.setDate(d.getDate() - i);
                    const dateStr = d.toISOString().split('T')[0];
                    const minutes = heatmapMap[dateStr] || 0;
                    let lv = 0;
                    if (minutes > 0) lv = 1;
                    if (minutes > 15) lv = 2;
                    if (minutes > 60) lv = 3;
                    if (minutes > 120) lv = 4;
                    html += `<div class="heat-cell heat-lv-${lv}" data-tip="${dateStr}: ${minutes}åˆ†é’Ÿ"></div>`;
                }
                grid.innerHTML = html;
            }
        } catch (e) { grid.innerHTML = 'åŠ è½½å¤±è´¥'; }
    }
    function sendHeartbeat() { fetch('/api/stats/heartbeat', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ is_heartbeat: true, book_key: dbKey }) }); }
    function reportWordCount() { fetch('/api/stats/heartbeat', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ words: document.getElementById('articleBody').innerText.length, book_key: dbKey }) }); }

    // === å…¶å®ƒ ===
    function handlePrefetch() {
        const next = document.getElementById('link-next');
        if(next && next.href) {
            const target = new URL(next.href).searchParams.get('url');
            if(target) setTimeout(() => fetch('/api/prefetch', { 
                method: 'POST', 
                headers: {'Content-Type': 'application/json'}, 
                body: JSON.stringify({ url: target }) 
            }), 3000);
        }
    }
    function toggleTTS() {
        let synth = window.speechSynthesis;
        if(window.isSpeaking) { 
            synth.cancel(); window.isSpeaking = false; 
            document.getElementById('ttsBtn').innerHTML = `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 5L6 9H2v6h4l5 4V5zM19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"/></svg> å¼€å§‹æœ—è¯»`;
        } else {
            const text = document.getElementById('chapterTitle').innerText + "ã€‚" + document.getElementById('articleBody').innerText;
            const utt = new SpeechSynthesisUtterance(text);
            utt.lang = 'zh-CN'; 
            utt.onend = () => { window.isSpeaking = false; document.getElementById('ttsBtn').innerText = "å¼€å§‹æœ—è¯»"; };
            synth.speak(utt); window.isSpeaking = true;
            document.getElementById('ttsBtn').innerHTML = `<span style="color:red">â¹ åœæ­¢</span>`;
            showToast("ğŸ§ æ­£åœ¨æœ—è¯»...");
        }
    }

    function showToast(m) { const x=document.getElementById("toast"); x.className="show"; x.innerText=m; setTimeout(()=>x.className="", 3000); }

    function escapeHtml(str) {
        return String(str)
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#39;")
            .replace(/`/g, "&#96;");
    }
    
    // ğŸ”¥ å¤„ç†"å·²æ˜¯æœ«å°¾"æ—¶è‡ªåŠ¨é‡æŠ“ç›®å½•
    async function handleNoNextChapter() {
        if (confirm('ğŸ“– å·²æ˜¯æœ€åä¸€ç« \n\næ˜¯å¦ç«‹å³é‡æ–°æŠ“å–ç›®å½•æ£€æŸ¥æ›´æ–°ï¼Ÿ')) {
            showToast('ğŸ”„ æ­£åœ¨é‡æ–°æŠ“å–ç›®å½•...');
            await loadTOC(true); // force=true å¼ºåˆ¶åˆ·æ–°
            
            // ç­‰å¾…1ç§’è®©ç›®å½•åŠ è½½å®Œæˆ
            setTimeout(() => {
                // é‡æ–°æ£€æŸ¥æ˜¯å¦æœ‰ä¸‹ä¸€ç« 
                const currentId = {{ chapter_id }};
                const tocUrl = "{{ article.toc }}";
                
                fetch(`/toc?url=${encodeURIComponent(tocUrl)}&key={{ db_key }}&api=1&force=true`)
                    .then(r => r.json())
                    .then(data => {
                        if (data.chapters) {
                            // æ‰¾åˆ°å½“å‰ç« èŠ‚çš„ä¸‹ä¸€ç« 
                            const currentIndex = data.chapters.findIndex(c => 
                                c.url === "{{ current_url }}" || c.id === currentId
                            );
                            
                            if (currentIndex >= 0 && currentIndex < data.chapters.length - 1) {
                                const nextChapter = data.chapters[currentIndex + 1];
                                showToast('âœ… å‘ç°æ–°ç« èŠ‚ï¼');
                                setTimeout(() => {
                                    window.location.href = `/read?url=${encodeURIComponent(nextChapter.url)}&key={{ db_key }}`;
                                }, 1000);
                            } else {
                                showToast('ğŸ’¤ ä»ç„¶æ˜¯æœ€æ–°ç« èŠ‚');
                            }
                        }
                    });
            }, 1500);
        }
    }
    
    /* === [æ–°å¢] é«˜çº§ï¼šæ— åˆ·æ–°åŠ è½½ä¸‹ä¸€ç«  (éª¨æ¶å±æ”¯æŒ) === */
    function setupAjaxNav(id) {
        const el = document.getElementById(id);
        if(!el) return;
        if(el.dataset.ajaxBound) return;
        el.dataset.ajaxBound = "true";
        
        el.addEventListener('click', (e) => {
            if(!e.ctrlKey && !e.metaKey && !e.shiftKey) {
                e.preventDefault();
                loadChapter(el.href);
            }
        });
    }

    /* === AJAX æ ¸å¿ƒé€»è¾‘ä¼˜åŒ– === */
async function loadChapter(url) {
    if(!url || url.includes('javascript:') || url.includes('#')) return;
    
    // 1. æ˜¾ç¤ºè¿›åº¦æ¡å’Œéª¨æ¶å±
    showProgressBar();
    toggleSkeletonState(true);
    
    // 2. æ»šåŠ¨åˆ°é¡¶éƒ¨(ä½¿ç”¨ instant é¿å…çœ‹åˆ°æ—§å†…å®¹)
    window.scrollTo({ top: 0, behavior: 'instant' });
    
    try {
        // 3. å‘èµ·è¯·æ±‚(å¢åŠ è¶…æ—¶å¤„ç†)
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 10000); // 10ç§’è¶…æ—¶
        
        updateProgressBar(30);
        
        const fetchUrl = url + (url.includes('?') ? '&' : '?') + 'mode=ajax';
        const res = await fetch(fetchUrl, { 
            signal: controller.signal 
        });
        clearTimeout(timeoutId);
        
        if(!res.ok) throw new Error('Network response was not ok');
        
        updateProgressBar(60);
        const json = await res.json();
        
        if(json.code === 0) {
            const data = json.data;
            
            updateProgressBar(80);
            
            // [å…³é”®ä¿®å¤] æ›´æ–°å½“å‰ç« èŠ‚IDï¼Œç¡®ä¿è¿œç¨‹è¿›åº¦æ£€æŸ¥æ­£å¸¸å·¥ä½œ
            if(json.chapter_id !== undefined) {
                localChapterId = parseInt(json.chapter_id) || -1;
                console.log(`[AJAX] æ›´æ–°ç« èŠ‚ID: ${localChapterId}`);
            }
            
            // 4. æ›´æ–° DOM(åˆ†é˜¶æ®µæ¸²æŸ“,é¿å…é—ªçƒ)
            await updatePageContent(data);
            
            // 5. æ›´æ–° URL & å½“å‰ç« èŠ‚çŠ¶æ€ï¼Œä¿è¯åç»­ /update ä½¿ç”¨æœ€æ–°åœ°å€
            if(json.current_url) currentUrl = json.current_url;
            history.pushState({ url }, '', url);
            
            updateProgressBar(95);
            
            // 6. éšè—éª¨æ¶å±
            toggleSkeletonState(false);
            
            // 7. é‡æ–°ç»‘å®šäº‹ä»¶
            rebindAjaxEvents();
            
            // 8. è‡ªåŠ¨ä¿å­˜è¿›åº¦
            autoSyncProgress();
            
            // 9. é¢„åŠ è½½ä¸‹ä¸€ç« 
            if(data.next_url) {
                setTimeout(() => prefetchChapter(data.next_url), 2000);
            }
            
            // 10. åˆ·æ–°ç›®å½•é«˜äº®(å¦‚æœç›®å½•å·²æ‰“å¼€)
            refreshTocHighlight();
            
            // 11. éšè—è¿›åº¦æ¡
            hideProgressBar();
            
        } else {
            throw new Error(json.msg || 'åŠ è½½å¤±è´¥');
        }
    } catch(e) {
        console.error('AJAX åŠ è½½é”™è¯¯:', e);
        hideProgressBar();
        
        if(e.name === 'AbortError') {
            showToast('â±ï¸ åŠ è½½è¶…æ—¶,æ­£åœ¨è·³è½¬...');
        } else {
            showToast('âŒ åŠ è½½å¤±è´¥,æ­£åœ¨è·³è½¬...');
        }
        
        // é™çº§ä¸ºä¼ ç»Ÿè·³è½¬
        setTimeout(() => location.href = url, 1000);
    }
}

/* éª¨æ¶å±çŠ¶æ€åˆ‡æ¢ */
function toggleSkeletonState(show) {
    const skBox = document.getElementById('skeletonBox');
    const contentBox = document.querySelector('.article-header');
    const bodyBox = document.querySelector('.content-body');
    const navBox = document.querySelector('.bottom-nav');
    
    if(show) {
        skBox.style.display = 'block';
        contentBox.style.display = 'none';
        bodyBox.style.display = 'none';
        navBox.style.display = 'none';
        
        // åœæ­¢æœ—è¯»
        if(window.isSpeaking && window.speechSynthesis) {
            window.speechSynthesis.cancel();
        }
    } else {
        skBox.style.display = 'none';
        contentBox.style.display = 'block';
        bodyBox.style.display = 'block';
        navBox.style.display = 'flex';
    }
}

/* åˆ†é˜¶æ®µæ›´æ–°é¡µé¢å†…å®¹ */
async function updatePageContent(data) {
    // 1. æ›´æ–°æ ‡é¢˜æ 
    document.title = data.title + ' - Smart NoteDB';
    
    // 2. æ›´æ–°ç« èŠ‚æ ‡é¢˜
    const contentBox = document.querySelector('.article-header');
    if(contentBox) {
        const h1 = contentBox.querySelector('h1');
        if(h1) h1.textContent = data.title;
        
        const meta = contentBox.querySelector('.article-meta');
        if(meta) {
            const wordCount = data.content.join('').length;
            meta.innerHTML = '';
            const wcSpan = document.createElement('span');
            wcSpan.textContent = `æœ¬ç« å­—æ•°: ${wordCount}å­—`;
            const srcSpan = document.createElement('span');
            srcSpan.textContent = `æ¥æº: ${dbKey}`;
            meta.appendChild(wcSpan);
            meta.appendChild(document.createTextNode(' '));
            meta.appendChild(srcSpan);
        }
    }
    
    // 3. æ›´æ–°æ­£æ–‡(ä½¿ç”¨ DocumentFragment ä¼˜åŒ–æ€§èƒ½)
    const bodyBox = document.querySelector('.content-body');
    if(bodyBox) {
        const fragment = document.createDocumentFragment();
        data.content.forEach(line => {
            const p = document.createElement('p');
            p.textContent = line;
            fragment.appendChild(p);
        });
        bodyBox.innerHTML = '';
        bodyBox.appendChild(fragment);
    }
    
    // 4. æ›´æ–°å¯¼èˆªæŒ‰é’®
    const nav = document.querySelector('.bottom-nav');
    if(nav) {
        let html = '';
        if(data.prev_url) {
            const prevLink = `/read?url=${encodeURIComponent(data.prev_url)}&key=${dbKey}`;
            html += `<a id="link-prev" href="${prevLink}" class="nav-btn">ä¸Šä¸€ç« </a>`;
        } else {
            html += `<span class="nav-btn disabled">å·²æ˜¯å¼€å¤´</span>`;
        }
        
        if(data.next_url) {
            const nextLink = `/read?url=${encodeURIComponent(data.next_url)}&key=${dbKey}`;
            html += `<a id="link-next" href="${nextLink}" class="nav-btn">ä¸‹ä¸€ç« </a>`;
        } else {
            html += `<span class="nav-btn disabled" onclick="handleNoNextChapter()" style="cursor:pointer;" title="ç‚¹å‡»é‡æ–°æ£€æŸ¥æ›´æ–°">å·²æ˜¯æœ«å°¾ ğŸ”„</span>`;
        }
        nav.innerHTML = html;
    }
    
    // 5. ç­‰å¾…ä¸€å¸§,ç¡®ä¿ DOM æ›´æ–°å®Œæˆ
    await new Promise(resolve => requestAnimationFrame(resolve));
}

/* é‡æ–°ç»‘å®š AJAX äº‹ä»¶ */
function rebindAjaxEvents() {
    setupAjaxNav('link-prev');
    setupAjaxNav('link-next');
}

/* é¢„åŠ è½½ä¸‹ä¸€ç«  */
function prefetchChapter(url) {
    fetch('/api/prefetch', { 
        method: 'POST', 
        headers: {'Content-Type': 'application/json'}, 
        body: JSON.stringify({ url: url }) 
    }).catch(() => {}); // é™é»˜å¤±è´¥
}

/* è¿›åº¦æ¡æ§åˆ¶ */
function showProgressBar() {
    const bar = document.getElementById('ajaxProgressBar');
    if(bar) bar.style.width = '0';
}

function updateProgressBar(percent) {
    const bar = document.getElementById('ajaxProgressBar');
    if(bar) bar.style.width = percent + '%';
}

function hideProgressBar() {
    const bar = document.getElementById('ajaxProgressBar');
    if(bar) {
        bar.style.width = '100%';
        setTimeout(() => { bar.style.width = '0'; }, 300);
    }
}

/* åˆ·æ–°ç›®å½•é«˜äº® */
function refreshTocHighlight() {
    const tocList = document.getElementById('tocList');
    if(!tocList || tocList.innerHTML === 'æ­£åœ¨åŠ è½½...') return;
    
    const items = tocList.querySelectorAll('.toc-item');
    // ä½¿ç”¨å½“å‰é¡µé¢ URL è€Œä¸æ˜¯åˆå§‹ currentUrl
    const currentPageUrl = window.location.href;
    const normCurrent = normalizeUrl(currentPageUrl);
    
    items.forEach(item => {
        const itemUrl = normalizeUrl(item.dataset.url || '');
        if(itemUrl === normCurrent) {
            item.classList.add('active');
            item.classList.add('active-chap');
            item.scrollIntoView({ block: 'center', behavior: 'smooth' });
        } else {
            item.classList.remove('active');
            item.classList.remove('active-chap');
        }
    });
}
    
    document.addEventListener('DOMContentLoaded', () => {
        const currentPath = window.location.href;
    history.replaceState({ url: currentPath }, '', currentPath);
        setupAjaxNav('link-prev');
        setupAjaxNav('link-next');
        
        // åˆå§‹åŒ–é˜…è¯»è¿›åº¦æ¡
        initReadingProgress();
        
        // [æ–°å¢] å¯åŠ¨ç»Ÿè®¡åŠŸèƒ½
        startStatistics();
    });
    
    /* === ç»Ÿè®¡åŠŸèƒ½ï¼ˆä¸ç§»åŠ¨ç«¯ä¿æŒä¸€è‡´ï¼‰ === */
    function sendHeartbeat() {
        fetch('/api/stats/heartbeat', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ 
                is_heartbeat: true, 
                book_key: dbKey 
            })
        }).catch(() => {});
    }
    
    function reportWordCount() {
        const bodyEl = document.querySelector('.content-body');
        if(bodyEl) {
            const wordCount = bodyEl.innerText.length;
            fetch('/api/stats/heartbeat', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ 
                    words: wordCount, 
                    book_key: dbKey 
                })
            }).catch(() => {});
        }
    }
    
    function startStatistics() {
        // åˆå§‹ä¸ŠæŠ¥
        reportWordCount();
        sendHeartbeat();
        
        // æ¯60ç§’å‘é€å¿ƒè·³
        setInterval(sendHeartbeat, 60000);
        
        // æ¯5åˆ†é’Ÿä¸ŠæŠ¥å­—æ•°
        setInterval(reportWordCount, 300000);
    }
    
    /* é˜…è¯»è¿›åº¦æ¡é€»è¾‘ */
    function initReadingProgress() {
        const progressBar = document.getElementById('readingProgressBar');
        if(!progressBar) return;
        
        let ticking = false;
        
        function updateProgress() {
            const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
            const docHeight = document.documentElement.scrollHeight - document.documentElement.clientHeight;
            const progress = docHeight > 0 ? (scrollTop / docHeight) * 100 : 0;
            progressBar.style.width = progress + '%';
            ticking = false;
        }
        
        window.addEventListener('scroll', () => {
            if(!ticking) {
                window.requestAnimationFrame(updateProgress);
                ticking = true;
            }
        });
        
        // åˆå§‹æ›´æ–°
        updateProgress();
    }

    window.addEventListener('popstate', (event) => {
    if(event.state && event.state.url) {
        // é€šè¿‡ AJAX åŠ è½½å†å²çŠ¶æ€
        loadChapter(event.state.url);
    } else {
        // é™çº§ä¸ºåˆ·æ–°é¡µé¢
        location.reload();
    }
});

    document.addEventListener('keydown', (e) => {
        // å¿½ç•¥åœ¨è¾“å…¥æ¡†ä¸­çš„æ“ä½œ
        if(['INPUT', 'TEXTAREA'].includes(e.target.tagName)) return;
        
        switch(e.key) {
            case 'ArrowLeft':
                e.preventDefault();
                document.getElementById('link-prev')?.click();
                break;
            case 'ArrowRight':
                e.preventDefault();
                document.getElementById('link-next')?.click();
                break;
            case 'Escape':
                document.querySelectorAll('.modal-overlay').forEach(m => m.style.display='none');
                break;
            case 't':
            case 'T':
                if(!e.ctrlKey && !e.metaKey) {
                    e.preventDefault();
                    showModal('tocOverlay');
                }
                break;
            case 's':
            case 'S':
                if(!e.ctrlKey && !e.metaKey) {
                    e.preventDefault();
                    showModal('settingModal');
                }
                break;
        }
    });
</script>

</body>
</html>