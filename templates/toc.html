<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ toc.title }} - ç›®å½•</title>
    <!-- å¼•å…¥ PureUI -->
    <link rel="stylesheet" href="/purecss/pure2.1.css">
    <style>
        body { background-color: #f9fafb; color: #1f2937; margin: 0; font-family: -apple-system, sans-serif; }
        
        /* é¡¶éƒ¨å¯¼èˆª */
        .navbar {
            background: #fff; padding: 12px 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            position: sticky; top: 0; z-index: 50;
            display: flex; justify-content: space-between; align-items: center;
        }
        .nav-title { font-weight: 700; font-size: 16px; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; max-width: 50%; }
        .nav-actions { display: flex; gap: 8px; }

        /* å®¹å™¨ */
        .container { max-width: 1000px; margin: 20px auto; padding: 0 15px; }
        
        /* === æ ¸å¿ƒä¿®å¤ï¼šæ¢å¤å®½å¡ç‰‡å¸ƒå±€ (ä¸‰åˆ—) === */
        .chapter-grid {
            display: grid;
            /* 280px å®½åº¦èƒ½ä¿è¯åœ¨å¤§å¤šæ•°ç”µè„‘å±å¹•ä¸Šæ˜¾ç¤º 3 åˆ—ï¼Œæ‰‹æœºæ˜¾ç¤º 1 åˆ— */
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); 
            gap: 15px;
            margin-top: 15px;
        }

        .chapter-item {
            background: #fff; border: 1px solid #e5e7eb; border-radius: 8px;
            padding: 15px; text-decoration: none; color: #374151;
            font-size: 15px; transition: 0.2s;
            display: flex; align-items: center; overflow: hidden;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        .chapter-item:hover {
            border-color: #4f46e5; color: #4f46e5; box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            transform: translateY(-2px);
        }
        .chap-id { color: #9ca3af; font-size: 13px; margin-right: 8px; min-width: 40px; font-weight: bold; }
        .chap-name { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-weight: 500; }

        /* ä¸‹è½½å¼¹çª— */
        #dl-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
        .modal-box { background: white; padding: 25px; border-radius: 12px; width: 90%; max-width: 400px; text-align: center; }
        .progress-bar { height: 10px; background: #f3f4f6; border-radius: 5px; margin: 15px 0; overflow: hidden; }
        .progress-fill { height: 100%; background: #4f46e5; width: 0%; transition: width 0.3s; }
    </style>
</head>
<body>

<div class="navbar">
    <div class="nav-title">ğŸ“š {{ toc.title }}</div>
    <div class="nav-actions">
        <a href="/" class="p-btn p-btn-sm" style="text-decoration:none; background:#f3f4f6;">ğŸ  ä¹¦æ¶</a>
        <button onclick="forceRefresh()" class="p-btn p-btn-sm p-btn-primary">ğŸ”„ åˆ·æ–°</button>
        <button onclick="startDownload()" id="dlBtn" class="p-btn p-btn-sm" style="background:#10b981; color:white; border:none;">ğŸ“¥ ä¸‹è½½TXT</button>
    </div>
</div>

<div class="container">
    <div style="display:flex; justify-content:space-between; color:#666; font-size:13px; margin-bottom:10px;">
        <span>å…± {{ toc.chapters|length }} ç« </span>
        <a href="{{ toc_url }}" target="_blank" style="color:#999; text-decoration:none;">æºç½‘é¡µ â†—</a>
    </div>

    <div class="chapter-grid">
        {% for chapter in toc.chapters %}
            <a href="/read?url={{ chapter.url }}&key={{ db_key }}" class="chapter-item" title="{{ chapter.raw_title or chapter.title }}">
                {% if chapter.id is defined and chapter.id > 0 %}
                    <span class="chap-id">{{ chapter.id }}</span>
                    <span class="chap-name">{{ chapter.name }}</span>
                {% else %}
                    <span class="chap-name">{{ chapter.raw_title or chapter.title }}</span>
                {% endif %}
            </a>
        {% endfor %}
    </div>
</div>

<div id="dl-modal">
    <div class="modal-box">
        <h3 style="margin-top:0">æ­£åœ¨æ‰“åŒ…ä¸‹è½½...</h3>
        <div class="progress-bar"><div class="progress-fill" id="p-fill"></div></div>
        <div id="p-text" style="font-size:13px; color:#666; margin-bottom:15px;">å‡†å¤‡ä¸­...</div>
        <div id="dl-finish" style="display:none;">
            <a href="#" id="dl-file-link" class="p-btn p-btn-primary" style="text-decoration:none;">ğŸ’¾ ä¿å­˜æ–‡ä»¶</a>
            <button onclick="closeModal()" class="p-btn" style="margin-left:10px; background:transparent; border:none; color:#666;">å…³é—­</button>
        </div>
    </div>
</div>

<script>
    const tocUrl = "{{ toc_url }}";
    const bookName = "{{ toc.title }}";
    let pollInterval = null;

    function forceRefresh() {
        let url = new URL(window.location.href);
        url.searchParams.set('force', 'true');
        window.location.href = url.toString();
    }

    function startDownload() {
        if(!confirm("ç¡®å®šè¦ä¸‹è½½å…¨æœ¬å—ï¼Ÿ\nç« èŠ‚è¶Šå¤šè€—æ—¶è¶Šé•¿ï¼Œè¯·ä¿æŒç½‘ç»œé€šç•…ã€‚")) return;
        document.getElementById('dlBtn').disabled = true;
        document.getElementById('dl-modal').style.display = 'flex';
        document.getElementById('dl-finish').style.display = 'none';
        
        fetch('/api/download', {
            method: 'POST', headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ toc_url: tocUrl, book_name: bookName })
        }).then(r=>r.json()).then(d => {
            if(d.status === 'success') pollProgress(d.task_id);
            else { alert(d.message); closeModal(); }
        }).catch(() => { alert("ç½‘ç»œé”™è¯¯"); closeModal(); });
    }

    function pollProgress(tid) {
        pollInterval = setInterval(() => {
            fetch(`/api/download/status?task_id=${tid}`).then(r=>r.json()).then(d => {
                const pct = Math.round((d.current / d.total) * 100);
                document.getElementById('p-fill').style.width = pct + '%';
                document.getElementById('p-text').innerText = `å·²ä¸‹è½½: ${d.current} / ${d.total} (${pct}%)`;
                if(d.status === 'completed' || d.status === 'error') {
                    clearInterval(pollInterval);
                    if(d.status === 'completed') {
                        document.getElementById('p-text').innerText = "âœ… æ‰“åŒ…å®Œæˆ";
                        document.getElementById('dl-file-link').href = `/api/download/file?task_id=${tid}`;
                        document.getElementById('dl-finish').style.display = 'block';
                    } else document.getElementById('p-text').innerText = "âŒ å¤±è´¥: " + d.error_msg;
                }
            });
        }, 2000);
    }
    function closeModal() {
        document.getElementById('dl-modal').style.display = 'none';
        document.getElementById('dlBtn').disabled = false;
        if(pollInterval) clearInterval(pollInterval);
    }
</script>
</body>
</html>